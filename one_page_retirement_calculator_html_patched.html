<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>One‑Page Retirement Calculator</title>
  <style>
    :root {
      --bg: #0b1220;
      --card: #121a2b;
      --muted: #7c8db5;
      --text: #e6eefc;
      --accent: #6ea8fe;
      --good: #45d483;
      --bad: #ff6b6b;
      --warn: #ffbf69;
      --border: #22304d;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, "Helvetica Neue", Arial, "Apple Color Emoji", "Segoe UI Emoji";
      margin: 0;
      color: var(--text);
      background: radial-gradient(1200px 900px at 15% -10%, #1a2440, #0b1220 50%);
    }
    header {
      padding: 20px clamp(16px, 3vw, 40px);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      position: sticky; top: 0; backdrop-filter: blur(6px);
      background: linear-gradient(180deg, rgba(11,18,32,.85), rgba(11,18,32,.55));
      border-bottom: 1px solid var(--border);
      z-index: 10;
    }
    .title { font-weight: 700; letter-spacing:.2px; }
    .title small{ color: var(--muted); font-weight: 500; }
    .wrap {
      display: grid;
      grid-template-columns: 360px 1fr;
      gap: 18px;
      padding: clamp(16px, 3vw, 40px);
      align-items: start;
    }
    @media (max-width: 980px){ .wrap{ grid-template-columns: 1fr; } }

    .card {
      background: linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.00));
      border: 1px solid var(--border);
      border-radius: 16px;
      box-shadow: 0 10px 30px rgba(0,0,0,.2);
    }
    .panel { padding: 18px; }
    .panel h3 { margin: 0 0 8px; font-size: 14px; color: var(--muted); font-weight: 600; letter-spacing:.4px; text-transform: uppercase; }

    /* Make inputs section independently scrollable */
    .card:first-of-type .sections {
      max-height: 100vh;
      overflow-y: auto;
    }

    .sections { display: grid; gap: 12px; }
    details { border: 1px solid var(--border); border-radius: 12px; overflow: hidden; }
    details[open] summary { background: #0d172b; }
    summary { padding: 14px 14px; cursor: pointer; list-style: none; user-select: none; display:flex; align-items:center; justify-content:space-between; gap:8px; }
    summary::-webkit-details-marker{ display:none; }
    .chev { transition: transform .2s; }
    details[open] .chev{ transform: rotate(90deg); }
    .content { padding: 14px; border-top: 1px dashed var(--border); background: rgba(255,255,255,.02); display:grid; gap:10px; }

    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .grid-1 { display: grid; grid-template-columns: repeat(1, 1fr); gap: 10px; }
    .grid-2 { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
    .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
    @media (max-width: 520px){ .grid, .grid-2, .grid-3 { grid-template-columns: 1fr; } }

    label { display: block; font-size: 12px; color: var(--muted); margin-bottom: 4px; }
    input, select { width: 100%; padding: 10px 11px; background: #0b1426; color: var(--text); border: 1px solid var(--border); border-radius: 10px; outline: none; }
    input:focus, select:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(110,168,254,.15); }
    .hint { font-size: 12px; color: var(--muted); }

    .actions { display:flex; gap:10px; padding: 14px; border-top: 1px solid var(--border); background: #0c1323; justify-content:flex-end; border-radius: 0 0 16px 16px; }
    button {
      appearance: none; border: 1px solid var(--border); background: #0f1930; color: var(--text);
      padding: 10px 14px; border-radius: 10px; font-weight: 600; cursor: pointer; transition: .2s;
    }
    .primary { background: linear-gradient(180deg, #2b63ff, #2349d2); border-color: #1f3fb8; }
    button:hover { transform: translateY(-1px); filter: brightness(1.07); }

    .results { 
      padding: 18px; 
      display: grid; 
      gap: 12px; 
      max-height: 90vh;
      overflow-y: auto;
    }
    .summary { display: grid; grid-template-columns: repeat(4, minmax(0,1fr)); gap: 10px; }
    @media (max-width: 900px){ .summary{ grid-template-columns: repeat(2, minmax(0,1fr)); } }
    .kpi { background: #0b1426; border: 1px solid var(--border); border-radius: 12px; padding: 12px; }
    .kpi .label { color: var(--muted); font-size: 12px; }
    .kpi .value { font-size: 20px; font-weight: 700; margin-top: 2px; }

    canvas { width: 100%; height: 260px; background: #0b1426; border: 1px solid var(--border); border-radius: 12px; }

    table { width: 100%; border-collapse: collapse; font-size: 13px; }
    th, td { border-bottom: 1px solid var(--border); padding: 8px; text-align: right; white-space: nowrap; }
    th:first-child, td:first-child, th:nth-child(2), td:nth-child(2) { text-align: left; }
    thead th { position: sticky; top: 0; background: #0d172b; z-index: 1; }
    tbody tr:hover { background: rgba(255,255,255,.03); }

    /* Color coding for table values */
    .income { color: #4ade80; } /* Green for income */
    .outgoing { color: #f87171; } /* Red for outgoing */
    .neutral { color: var(--text); } /* Default color for neutral items */

    .pill { padding:.2rem .5rem; border-radius: 999px; font-size: 12px; font-weight:600; display:inline-block; }
    .ok { color: #0b5; background: rgba(69,212,131,.15); border: 1px solid rgba(69,212,131,.3); }
    .alert { color: #ff6b6b; background: rgba(255,107,107,.15); border:1px solid rgba(255,107,107,.3); }
    .warn { color: #ffbf69; background: rgba(255,191,105,.15); border:1px solid rgba(255,191,105,.3); }
    .disclaimer { color: var(--muted); font-size: 12px; }
    
    /* Toast Notification Styles */
    .toast {
      position: fixed !important;
      top: 20px !important;
      right: 20px !important;
      background: #fffbf0 !important;
      border: 1px solid #f0ad4e !important;
      border-radius: 8px !important;
      padding: 16px !important;
      max-width: 300px !important;
      box-shadow: 0 4px 12px rgba(240, 173, 78, 0.3) !important;
      z-index: 99999 !important;
      opacity: 0 !important;
      transform: translateY(-10px) !important;
      transition: opacity 0.3s ease, transform 0.3s ease !important;
      overflow: visible !important;
      pointer-events: auto !important;
      display: block !important;
      visibility: visible !important;
      width: auto !important;
      height: auto !important;
    }
    .toast.show {
      opacity: 1 !important;
      transform: translateY(0) !important;
      visibility: visible !important;
    }
    .toast .toast-title {
      font-weight: 600;
      color: #8a6914;
      margin-bottom: 8px;
      font-size: 14px;
    }
    .toast .toast-body {
      color: #856404;
      font-size: 13px;
      line-height: 1.4;
    }
    .toast .progress-bar {
      position: absolute;
      bottom: 0;
      left: 0;
      height: 3px;
      background: #f0ad4e;
      transition: width linear;
      border-radius: 0 0 8px 8px;
      width: 0%;
    }
    
    /* Toast Type Variations */
    .toast-success {
      background: #f0fff4 !important;
      border-color: #28a745 !important;
      box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3) !important;
    }
    .toast-success .toast-title {
      color: #155724;
    }
    .toast-success .toast-body {
      color: #155724;
    }
    .toast-success .progress-bar {
      background: #28a745;
    }
    
    .toast-error {
      background: #fff5f5 !important;
      border-color: #dc3545 !important;
      box-shadow: 0 4px 12px rgba(220, 53, 69, 0.3) !important;
    }
    .toast-error .toast-title {
      color: #721c24;
    }
    .toast-error .toast-body {
      color: #721c24;
    }
    .toast-error .progress-bar {
      background: #dc3545;
    }
    
    .toast-warning {
      background: #fffbf0 !important;
      border-color: #ffc107 !important;
      box-shadow: 0 4px 12px rgba(255, 193, 7, 0.3) !important;
    }
    .toast-warning .toast-title {
      color: #856404;
    }
    .toast-warning .toast-body {
      color: #856404;
    }
    .toast-warning .progress-bar {
      background: #ffc107;
    }
    
    .toast-info {
      background: #f0f8ff !important;
      border-color: #17a2b8 !important;
      box-shadow: 0 4px 12px rgba(23, 162, 184, 0.3) !important;
    }
    .toast-info .toast-title {
      color: #0c5460;
    }
    .toast-info .toast-body {
      color: #0c5460;
    }
    .toast-info .progress-bar {
      background: #17a2b8;
    }
    
    .help-icon {
      cursor: pointer;
      transition: opacity 0.2s ease;
      margin-left: 0.3em;
      vertical-align: middle;
    }
    .help-icon:hover {
      opacity: 0.7;
    }
  </style>
</head>
<body>
  <header>
    <div class="title">
      <div style="font-size:20px">Retirement Calculator</div>
      <small>Pre‑tax vs Roth vs Taxable • Social Security • Pension • Spouse benefits • Declining spending • Employer match</small>
    </div>
    <div>
      <input type="file" id="jsonFileInput" accept=".json" style="display: none;">
      <button id="clearBtn">Reset</button>
      <button id="calcBtn" class="primary" title="Calculate (Ctrl+Enter)">Calculate ▶</button>
    </div>
  </header>

  <main class="wrap">
    <!-- Inputs -->
    <section class="card">
      <div class="panel">
        <h3>Inputs</h3>
        <div class="sections">
          <!-- Personal -->
          <details>
            <summary>
              <span>Personal & Timeline</span>
              <span class="chev">▶</span>
            </summary>
            <div class="content grid">
              <div>
                <label for="currentAge">Current age 
                  <span class="help-icon-placeholder" data-field="currentAge"></span>
                </label>
                <input id="currentAge" type="number" min="18" max="80" step="1" value="45" />
              </div>
              <div>
                <label for="retireAge">Retirement age
                  <span class="help-icon-placeholder" data-field="retireAge"></span>
                </label>
                <input id="retireAge" type="number" min="40" max="80" step="1" value="67" />
              </div>
              <div>
                <label for="endAge">Plan to age
                  <span class="help-icon-placeholder" data-field="endAge"></span>
                </label>
                <input id="endAge" type="number" min="70" max="110" step="1" value="95" />
              </div>
              <div>
                <label for="inflation">Inflation (%)
                  <span class="help-icon-placeholder" data-field="inflation"></span>
                </label>
                <input id="inflation" type="number" step="0.1" value="2.5" />
              </div>
              <div>
                <label for="spendingToday">Retirement spending (today's $ / yr)
                  <span class="help-icon-placeholder" data-field="spendingToday"></span>
                </label>
                <input id="spendingToday" type="number" step="1000" value="80000" />
                <div class="hint">We'll inflate this to retirement, then apply COLA annually.</div>
              </div>
              <div>
                <label for="spendingDecline">Annual spending decline in retirement (%)
                  <span class="help-icon-placeholder" data-field="spendingDecline"></span>
                </label>
                <input id="spendingDecline" type="number" step="0.1" value="0" />
                <div class="hint">Spending reduction each year (e.g., 2% = spending drops to 98%, then 96%, etc.)</div>
              </div>
            </div>
          </details>

          <!-- Spouse Information -->
          <details>
            <summary>
              <span>Spouse Information</span>
              <span class="chev">▶</span>
            </summary>
            <div class="content">
              <div class="grid-2">
                <div>
                  <label for="spouseAge">Current age
                    <span class="help-icon-placeholder" data-field="spouseAge"></span>
                  </label>
                  <input id="spouseAge" type="number" min="18" max="80" step="1" value="0" />
                  <div class="hint">Set to 0 if no spouse</div>
                </div>
                <div>
                  <label for="spouseRetireAge">Retirement age
                    <span class="help-icon-placeholder" data-field="spouseRetireAge"></span>
                  </label>
                  <input id="spouseRetireAge" type="number" min="40" max="80" step="1" value="67" />
                </div>
              </div>
              <div class="grid-1">
                
                <div>
                  <label for="spouseSsStart">Social Sec start age</label>
                  <input id="spouseSsStart" type="number" step="1" value="67" />
                </div>
              </div>
              <div class="grid-2">
                <div>
                  <label for="spouseSsMonthly">$/Month (1st yr benefits)</label>
                  <input id="spouseSsMonthly" type="number" step="50" value="0" />
                </div>
                
                <div>
                  <label for="spouseSsCola">Social Sec COLA (%/yr)</label>
                  <input id="spouseSsCola" type="number" step="0.1" value="2.0" />
                </div>
              </div>
              <div class=""grid-1">
                <div>
                  <label for="spousePenStart">Pension start age</label>
                  <input id="spousePenStart" type="number" step="1" value="65" />
                </div>
              </div>
              <div class="grid-2">
                <div>
                  <label for="spousePenMonthly">Pension disbursement ($/mo, first year)</label>
                  <input id="spousePenMonthly" type="number" step="50" value="0" />
                </div>
                <div>
                  <label for="spousePenCola">Spouse Pension COLA (%/yr)</label>
                  <input id="spousePenCola" type="number" step="0.1" value="0" />
                </div>
              </div>
              <div class="grid-2">
                <div>
                  <label for="spouseTaxSS">Effective tax on Spouse Social Security (%)</label>
                  <input id="spouseTaxSS" type="number" step="0.5" value="10" />
                </div>
                <div>
                  <label for="spouseTaxPension">Effective tax on Spouse Pension (%)</label>
                  <input id="spouseTaxPension" type="number" step="0.5" value="20" />
                </div>
              </div>
            </div>
          </details>

          <!-- Work & Contributions -->
          <details>
            <summary>
              <span>Work & Contributions</span>
              <span class="chev">▶</span>
            </summary>
            <div class="content">
              <div class="grid">
                <div>
                  <label for="salary">Current salary ($/yr)
                    <span class="help-icon-placeholder" data-field="salary"></span>
                  </label>
                  <input id="salary" type="number" step="1000" value="150000" />
                </div>
                <div>
                  <label for="salaryGrowth">Salary growth (%)
                    <span class="help-icon-placeholder" data-field="salaryGrowth"></span>
                  </label>
                  <input id="salaryGrowth" type="number" step="0.1" value="3.0" />
                </div>
              </div>
              <div>
                <label for="pretaxPct">Pre‑tax 401k/IRA contribution (% of salary)
                  <span class="help-icon-placeholder" data-field="pretaxPct"></span>
                </label>
                <input id="pretaxPct" type="number" step="0.1" value="10" />
              </div>
              <div>
                <label for="rothPct">Roth contribution (% of salary)
                  <span class="help-icon-placeholder" data-field="rothPct"></span>
                </label>
                <input id="rothPct" type="number" step="0.1" value="5" />
              </div>
              <div>
                <label for="taxablePct">Savings rate (% of salary)
                  <span class="help-icon-placeholder" data-field="taxablePct"></span>
                </label>
                <input id="taxablePct" type="number" step="0.1" value="2" />
              </div>
              <div>
                <label for="matchCap">Employer 401k match up to (% of salary)</label>
                <input id="matchCap" type="number" step="0.1" value="4" />
              </div>
              <div>
                <label for="matchRate">Employer 401k match rate (%)</label>
                <input id="matchRate" type="number" step="1" value="50" />
              </div>
            </div>
          </details>

          <!-- Balances & Returns -->
          <details>
            <summary>
              <span>Balances & Returns</span>
              <span class="chev">▶</span>
            </summary>
            <div class="content">
              <div class="grid-1">
                <div>
                  <label for="balPre">Pre‑tax (401k/Trad IRA) balance
                    <svg xmlns="http://www.w3.org/2000/svg" 
                         viewBox="0 0 24 24" 
                         width="1em" height="1em" 
                         fill="white" 
                         class="help-icon"
                         onclick="showHelpToast(event, 'balPre')"
                         style="vertical-align: middle;">
                      <circle cx="12" cy="12" r="10" stroke="white" stroke-width="2" fill="none"/>
                      <path d="M9.5 9a2.5 2.5 0 0 1 5 0c0 1.5-2.5 2-2.5 3.5v1" stroke="white" stroke-width="2" fill="none" stroke-linecap="round"/>
                      <circle cx="12" cy="17" r="1" fill="white"/>
                    </svg>
                  </label>
                  <input id="balPre" type="number" step="1000" value="400000" />
                </div>
                <div class="grid-1">
                <div>
                  <label for="balRoth">Roth balance (tax-free)
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="1em" height="1em" fill="white" class="help-icon"
                      onclick="showHelpToast(event, 'balRoth')" style="vertical-align: middle;">
                      <circle cx="12" cy="12" r="10" stroke="white" stroke-width="2" fill="none" />
                      <path d="M9.5 9a2.5 2.5 0 0 1 5 0c0 1.5-2.5 2-2.5 3.5v1" stroke="white" stroke-width="2" fill="none"
                        stroke-linecap="round" />
                      <circle cx="12" cy="17" r="1" fill="white" />
                    </svg>
                  </label>
                  <input id="balRoth" type="number" step="1000" value="100000" />
                </div>

                </div>
                <div class="grid-1">
                  <label for="balSavings">Savings balance (taxable interest/dividends)
                    <svg xmlns="http://www.w3.org/2000/svg" 
                         viewBox="0 0 24 24" 
                         width="1em" height="1em" 
                         fill="white" 
                         class="help-icon"
                         onclick="showHelpToast(event, 'balSavings')"
                         style="vertical-align: middle;">
                      <circle cx="12" cy="12" r="10" stroke="white" stroke-width="2" fill="none"/>
                      <path d="M9.5 9a2.5 2.5 0 0 1 5 0c0 1.5-2.5 2-2.5 3.5v1" stroke="white" stroke-width="2" fill="none" stroke-linecap="round"/>
                      <circle cx="12" cy="17" r="1" fill="white"/>
                    </svg>
                  </label>
                  <input id="balSavings" type="number" step="1000" value="80000" />
                </div>
              </div>
              <div class="grid-3">
                <div>
                  <label for="retPre">Pre‑tax return (%/yr)
                    <svg xmlns="http://www.w3.org/2000/svg" 
                         viewBox="0 0 24 24" 
                         width="1em" height="1em" 
                         fill="white" 
                         class="help-icon"
                         onclick="showHelpToast(event, 'retPre')"
                         style="vertical-align: middle;">
                      <circle cx="12" cy="12" r="10" stroke="white" stroke-width="2" fill="none"/>
                      <path d="M9.5 9a2.5 2.5 0 0 1 5 0c0 1.5-2.5 2-2.5 3.5v1" stroke="white" stroke-width="2" fill="none" stroke-linecap="round"/>
                      <circle cx="12" cy="17" r="1" fill="white"/>
                    </svg>
                  </label>
                  <input id="retPre" type="number" step="0.1" value="6.0" />
                </div>
                <div>
                  <label for="retRoth">Roth return (%/yr)
                    <svg xmlns="http://www.w3.org/2000/svg" 
                         viewBox="0 0 24 24" 
                         width="1em" height="1em" 
                         fill="white" 
                         class="help-icon"
                         onclick="showHelpToast(event, 'retRoth')"
                         style="vertical-align: middle;">
                      <circle cx="12" cy="12" r="10" stroke="white" stroke-width="2" fill="none"/>
                      <path d="M9.5 9a2.5 2.5 0 0 1 5 0c0 1.5-2.5 2-2.5 3.5v1" stroke="white" stroke-width="2" fill="none" stroke-linecap="round"/>
                      <circle cx="12" cy="17" r="1" fill="white"/>
                    </svg>
                  </label>
                  <input id="retRoth" type="number" step="0.1" value="6.0" />
                </div>
                <div>
                  <label for="retTax">Savings return (APY)
                    <svg xmlns="http://www.w3.org/2000/svg" 
                         viewBox="0 0 24 24" 
                         width="1em" height="1em" 
                         fill="white" 
                         class="help-icon"
                         onclick="showHelpToast(event, 'retTax')"
                         style="vertical-align: middle;">
                      <circle cx="12" cy="12" r="10" stroke="white" stroke-width="2" fill="none"/>
                      <path d="M9.5 9a2.5 2.5 0 0 1 5 0c0 1.5-2.5 2-2.5 3.5v1" stroke="white" stroke-width="2" fill="none" stroke-linecap="round"/>
                      <circle cx="12" cy="17" r="1" fill="white"/>
                    </svg>
                  </label>
                  <input id="retTax" type="number" step="0.1" value="5.5" />
                </div>
              </div>
            </div>
          </details>

          <!-- Income Sources -->
          <details>
            <summary>
              <span>Social Security & Pension</span>
              <span class="chev">▶</span>
            </summary>
            <div class="content">
              <div class="grid-2">
                <div>
                  <label for="ssMonthly">Social Security ($/mo, first year)
                    <svg xmlns="http://www.w3.org/2000/svg" 
                         viewBox="0 0 24 24" 
                         width="1em" height="1em" 
                         fill="white" 
                         class="help-icon"
                         onclick="showHelpToast(event, 'ssMonthly')"
                         style="vertical-align: middle;">
                      <circle cx="12" cy="12" r="10" stroke="white" stroke-width="2" fill="none"/>
                      <path d="M9.5 9a2.5 2.5 0 0 1 5 0c0 1.5-2.5 2-2.5 3.5v1" stroke="white" stroke-width="2" fill="none" stroke-linecap="round"/>
                      <circle cx="12" cy="17" r="1" fill="white"/>
                    </svg>
                  </label>
                  <input id="ssMonthly" type="number" step="50" value="2800" />
                </div>
                <div>
                  <label for="ssStart">SS start age
                    <svg xmlns="http://www.w3.org/2000/svg" 
                         viewBox="0 0 24 24" 
                         width="1em" height="1em" 
                         fill="white" 
                         class="help-icon"
                         onclick="showHelpToast(event, 'ssStart')"
                         style="vertical-align: middle;">
                      <circle cx="12" cy="12" r="10" stroke="white" stroke-width="2" fill="none"/>
                      <path d="M9.5 9a2.5 2.5 0 0 1 5 0c0 1.5-2.5 2-2.5 3.5v1" stroke="white" stroke-width="2" fill="none" stroke-linecap="round"/>
                      <circle cx="12" cy="17" r="1" fill="white"/>
                    </svg>
                  </label>
                  <input id="ssStart" type="number" step="1" value="67" />
                </div>
                <div>
                  <label for="ssCola">SS COLA (%/yr)
                    <svg xmlns="http://www.w3.org/2000/svg" 
                         viewBox="0 0 24 24" 
                         width="1em" height="1em" 
                         fill="white" 
                         class="help-icon"
                         onclick="showHelpToast(event, 'ssCola')"
                         style="vertical-align: middle;">
                      <circle cx="12" cy="12" r="10" stroke="white" stroke-width="2" fill="none"/>
                      <path d="M9.5 9a2.5 2.5 0 0 1 5 0c0 1.5-2.5 2-2.5 3.5v1" stroke="white" stroke-width="2" fill="none" stroke-linecap="round"/>
                      <circle cx="12" cy="17" r="1" fill="white"/>
                    </svg>
                  </label>
                  <input id="ssCola" type="number" step="0.1" value="2.0" />
                </div>
              </div>
              <div class="grid-3">
                <div>
                  <label for="penMonthly">Pension ($/mo, first year)
                    <svg xmlns="http://www.w3.org/2000/svg" 
                         viewBox="0 0 24 24" 
                         width="1em" height="1em" 
                         fill="white" 
                         class="help-icon"
                         onclick="showHelpToast(event, 'penMonthly')"
                         style="vertical-align: middle;">
                      <circle cx="12" cy="12" r="10" stroke="white" stroke-width="2" fill="none"/>
                      <path d="M9.5 9a2.5 2.5 0 0 1 5 0c0 1.5-2.5 2-2.5 3.5v1" stroke="white" stroke-width="2" fill="none" stroke-linecap="round"/>
                      <circle cx="12" cy="17" r="1" fill="white"/>
                    </svg>
                  </label>
                  <input id="penMonthly" type="number" step="50" value="0" />
                </div>
                <div>
                  <label for="penStart">Pension start age
                    <svg xmlns="http://www.w3.org/2000/svg" 
                         viewBox="0 0 24 24" 
                         width="1em" height="1em" 
                         fill="white" 
                         class="help-icon"
                         onclick="showHelpToast(event, 'penStart')"
                         style="vertical-align: middle;">
                      <circle cx="12" cy="12" r="10" stroke="white" stroke-width="2" fill="none"/>
                      <path d="M9.5 9a2.5 2.5 0 0 1 5 0c0 1.5-2.5 2-2.5 3.5v1" stroke="white" stroke-width="2" fill="none" stroke-linecap="round"/>
                      <circle cx="12" cy="17" r="1" fill="white"/>
                    </svg>
                  </label>
                  <input id="penStart" type="number" step="1" value="65" />
                </div>
                <div>
                  <label for="penCola">Pension COLA (%/yr)
                    <svg xmlns="http://www.w3.org/2000/svg" 
                         viewBox="0 0 24 24" 
                         width="1em" height="1em" 
                         fill="white" 
                         class="help-icon"
                         onclick="showHelpToast(event, 'penCola')"
                         style="vertical-align: middle;">
                      <circle cx="12" cy="12" r="10" stroke="white" stroke-width="2" fill="none"/>
                      <path d="M9.5 9a2.5 2.5 0 0 1 5 0c0 1.5-2.5 2-2.5 3.5v1" stroke="white" stroke-width="2" fill="none" stroke-linecap="round"/>
                      <circle cx="12" cy="17" r="1" fill="white"/>
                    </svg>
                  </label>
                  <input id="penCola" type="number" step="0.1" value="0" />
                </div>
              </div>
            </div>
          </details>

          <!-- Taxes & Strategy -->
          <details>
            <summary>
              <span>Taxes & Withdrawal Strategy</span>
              <span class="chev">▶</span>
            </summary>
            <div class="content">
              <div class="grid-3">
                <div>
                  <label for="taxPre">Effective tax on pre‑tax withdrawals (%)
                    <span class="help-icon-placeholder" data-field="taxPre"></span>
                  </label>
                  <input id="taxPre" type="number" step="0.5" value="22" />
                </div>
                <div>
                  <label for="taxTaxable">Effective tax on taxable withdrawals (%)
                    <span class="help-icon-placeholder" data-field="taxTaxable"></span>
                  </label>
                  <input id="taxTaxable" type="number" step="0.5" value="10" />
                </div>
                <div>
                  <label for="taxRoth">Effective tax on Roth withdrawals (%)
                    <span class="help-icon-placeholder" data-field="taxRoth"></span>
                  </label>
                  <input id="taxRoth" type="number" step="0.5" value="0" />
                </div>
              </div>
              <div class="grid-3">
                <div>
                  <label for="taxSS">Effective tax on Social Security (%)
                    <span class="help-icon-placeholder"  data-field="taxSS"></span>
                  </label>
                  <input id="taxSS" type="number" step="0.5" value="10" />
                </div>
                <div>
                  <label for="taxPension">Effective tax on Pension (%)
                    <span class="help-icon-placeholder" data-field="taxPension"></span>
                  </label>
                  <input id="taxPension" type="number" step="0.5" value="20" />
                </div>
                <div>
                  <label for="order">Withdrawal order
                    <span class="help-icon-placeholder" data-field="order"></span>
                  </label>
                  <select id="order">
                    <option value="taxable,pretax,roth">Taxable → Pre‑tax → Roth (default)</option>
                    <option value="pretax,taxable,roth">Pre‑tax → Taxable → Roth</option>
                    <option value="roth,pretax,taxable">Roth → Pre‑tax → Taxable</option>
                  </select>
                </div>
              </div>
              <div style="margin-top: 15px;">
                <div style="display: flex; align-items: center; gap: 5px;">
                  <input type="checkbox" id="useAgiTax" checked style="width: auto;" />
                  <label for="useAgiTax">
                    Use Taxable Income-based tax calculation for pre-tax withdrawals and pension income
                    <span class="help-icon-placeholder" data-field="useAgiTax"></span>
                  </label>
                </div>
              </div>
              <div style="margin-top: 10px;">
                <label for="filingStatus">Tax filing status
                  <span class="help-icon-placeholder" data-field="filingStatus"></span>
                </label>
                <select id="filingStatus">
                  <option value="single">Single</option>
                  <option value="married">Married Filing Jointly</option>
                </select>
              </div>
              <div style="margin-top: 10px;">
                <div style="display: flex; align-items: center; gap: 5px;">
                  <input type="checkbox" id="useSSRules" checked style="width: auto;" />
                  <label for="useSSRules">
                    Use proper Social Security taxation rules
                    <span class="help-icon-placeholder" data-field="useSSRules"></span>
                  </label>
                </div>
              </div>
              <div style="margin-top: 10px;">
                <div style="display: flex; align-items: center; gap: 5px;">
                  <input type="checkbox" id="useRMD" checked style="width: auto;" />
                  <label for="useRMD">
                    Apply Required Minimum Distribution (RMD) rules
                    <span class="help-icon-placeholder" data-field="useRMD"></span>
                  </label>
                </div>
              </div>
              <div class="hint">These are simplified, all‑in effective rates to keep the model understandable (not tax advice).</div>
            </div>
          </details>

          <!-- Annual Spending Details -->
          <details>
            <summary>
              <span>Annual Spending Details</span>
              <span class="chev">▶</span>
            </summary>
            <div class="content">
              <div class="hint">
                <div style="margin-bottom: 8px;">
                  Override calculated annual income for specific retirement years.
                  Leave fields blank to use automatic annual income calculations based on COLA and spending decline.
                </div>
                <div style="display: flex; align-items: center; gap: 5px;">
                  <input type="checkbox" id="useCurrentYearValues" style="width: auto;" />
                  <label for="useCurrentYearValues">
                    Use current year values (will be adjusted for inflation for target year)
                  </label>
                </div>
              </div>
            
              <div id="spendingDetailsGrid" class="grid-3">
                <!-- Spending override fields will be dynamically generated here -->
              </div>
            </div>
          </details>
        </div>
      </div>
      <div class="actions">
        <button id="csvBtn" title="Export yearly table">Export CSV</button>
        <button id="exportJsonBtn" title="Export inputs as JSON file">Export JSON</button>
        <button id="importJsonBtn" title="Import inputs from JSON file">Import JSON</button>
      </div>
    </section>

    <!-- Results -->
    <section class="card">
      <div class="results">
        <div class="summary">
          <div class="kpi"><div class="label">Retirement Age</div><div id="kpiDraw" class="value">—</div></div>
          <div class="kpi"><div class="label">Funded to Age</div><div id="kpiAge" class="value">—</div></div>
          <div class="kpi"><div class="label">Starting Balance</div><div id="kpiTax" class="value">—</div></div>
          <div class="kpi"><div class="label">Ending Balance</div><div id="kpiEndBal" class="value">—</div></div>
        </div>
        <canvas id="chart" height="260"></canvas>
        <div class="card" style="padding:0; overflow:auto; max-height: 50vh;">
          <table>
            <thead>
              <tr>
                <th>Year</th>
                <th>Age</th>
                <th>Annual Spend</th>
                <th>Salary</th>
                <th>Contrib (Tot)</th>
                <th>SS (Net)</th>
                <th>Pension (Net)</th>
                <th>Spouse SS (Net)</th>
                <th>Spouse Pen (Net)</th>
                <th>Withdraw Net</th>
                <th>401k Gross</th>
                <th>Savings Gross</th>
                <th>Roth Gross</th>
                <th>Total Taxes</th>
                <th>SS Taxes</th>
                <th>Other Taxes</th>
                <th>Non-Taxable Income</th>
                <th>Taxable Income</th>
                <th>Earned Interest</th>
                <th>Effective Tax Rate</th>
                <th>Savings Bal</th>
                <th>401k Bal</th>
                <th>Roth Bal</th>
                <th>Total Bal</th>
              </tr>
            </thead>
            <tbody id="rows"></tbody>
          </table>
        </div>
        <div class="disclaimer">This is an educational, simplified model. It ignores many realities (RMDs, detailed SS taxability, brackets/credits, healthcare, sequence risk, etc.). Consult a fiduciary advisor and a tax professional for personalized guidance.</div>
      </div>
    </section>
  </main>

  <script>
  // --- Added by patch: 2025 elective deferral limits (401k/Roth 401k) ---
  const EMPLOYEE_401K_LIMIT_2025 = 23000;      // elective deferral
  const EMPLOYEE_401K_CATCHUP_50 = 7500;       // catch-up age 50+

  // Track previous ages to only regenerate spending fields when they change
  let lastRetireAge = null;
  let lastEndAge = null;

    const $ = (id) => document.getElementById(id);
    const pct = (v) => (isNaN(v) ? 0 : Number(v)/100);
    const num = (id) => Number($(id).value || 0);
    const fmt = (n) => n.toLocaleString(undefined, { style: 'currency', currency: 'USD', maximumFractionDigits: 0 });
    const pow1p = (r, n) => Math.pow(1 + r, n);

    /**
     * Effective Tax Rate Table and Standard Deductions
     *
     * This table provides estimated effective federal tax rates for different Taxable Income levels.
     * These rates are based on 2025 tax brackets and include proper
     * standard deduction handling.
     *
     * 2025 Standard Deductions:
     * - Single filers: $15,000 (estimated)
     * - Married filing jointly: $32,600
     *
     * Note: These are simplified estimates and do not account for:
     * - State taxes
     * - Itemized deductions beyond standard deduction
     * - Tax credits
     * - FICA taxes on earned income
     * - Capital gains vs ordinary income distinctions
     * - Additional standard deduction for seniors (65+)
     *
     * For accurate tax planning, consult a tax professional.
     */
    
    // 2025 Standard Deductions
    const STANDARD_DEDUCTIONS = {
      single: 15000,
      married: 32600
    };
    const EFFECTIVE_TAX_RATES = {
      // Taxable Income: Effective Rate (%) - Based on 2025 Married Filing Jointly Tax Brackets
      // 10%: $0 – $23,200, 12%: $23,200 – $94,300, 22%: $94,300 – $201,050, 24%: $201,050+
      // These rates are applied to Taxable Income (after standard deduction)
      0: 0.0,
      5000: 10.0,    // $5,000 × 10% = $500 → 10.0%
      10000: 10.0,   // $10,000 × 10% = $1,000 → 10.0%
      15000: 10.0,   // $15,000 × 10% = $1,500 → 10.0%
      20000: 10.0,   // $20,000 × 10% = $2,000 → 10.0%
      23200: 10.0,   // $23,200 × 10% = $2,320 → 10.0%
      30000: 10.5,   // $2,320 + $6,800×12% = $3,136 → 10.5%
      40000: 10.8,   // $2,320 + $16,800×12% = $4,336 → 10.8%
      50000: 11.1,   // $2,320 + $26,800×12% = $5,536 → 11.1%
      60000: 11.2,   // $2,320 + $36,800×12% = $6,736 → 11.2%
      70000: 11.3,   // $2,320 + $46,800×12% = $7,936 → 11.3%
      74900: 11.4,   // $2,320 + $51,700×12% = $8,524 → 11.4% (matches your example)
      80000: 11.4,   // $2,320 + $56,800×12% = $9,136 → 11.4%
      90000: 11.5,   // $2,320 + $66,800×12% = $10,336 → 11.5%
      94300: 11.5,   // $2,320 + $71,100×12% = $10,852 → 11.5%
      100000: 12.1,  // $10,852 + $5,700×22% = $12,106 → 12.1%
      110000: 12.7,  // $10,852 + $15,700×22% = $14,306 → 13.0%
      120000: 13.5,  // $10,852 + $25,700×22% = $16,506 → 13.8%
      130000: 14.1,  // $10,852 + $35,700×22% = $18,706 → 14.4%
      140000: 14.9,  // $10,852 + $45,700×22% = $20,906 → 14.9%
      150000: 15.5,  // $10,852 + $55,700×22% = $23,106 → 15.4%
      160000: 16.0,  // $10,852 + $65,700×22% = $25,306 → 15.8%
      170000: 16.4,  // $10,852 + $75,700×22% = $27,506 → 16.2%
      180000: 16.9,  // $10,852 + $85,700×22% = $29,706 → 16.5%
      190000: 17.3,  // $10,852 + $95,700×22% = $31,906 → 16.8%
      200000: 17.6,  // $10,852 + $105,700×22% = $34,106 → 17.1%
      201050: 17.7,  // $10,852 + $106,750×22% = $34,337 → 17.1%
      220000: 18.1,  // $34,337 + $18,950×24% = $38,885 → 17.7%
      240000: 18.5,  // $34,337 + $38,950×24% = $43,685 → 18.2%
      260000: 18.9,  // $34,337 + $58,950×24% = $48,485 → 18.6%
      280000: 19.2,  // $34,337 + $78,950×24% = $53,285 → 19.0%
      300000: 19.5,  // $34,337 + $98,950×24% = $58,085 → 19.4%
    };

    /**
     * Calculate Taxable Income by subtracting standard deduction from gross income
     * @param {number} grossIncome - Total gross income
     * @param {string} filingStatus - 'single' or 'married'
     * @returns {number} Adjusted Gross Income (cannot be negative)
     */
    function calculateTaxableIncome(grossIncome, filingStatus = "single") {
      const standardDeduction = STANDARD_DEDUCTIONS[filingStatus] || STANDARD_DEDUCTIONS.single;
      return Math.max(0, grossIncome - standardDeduction);
    }

    /**
     * Calculate effective tax rate for a given Taxable Income using linear interpolation
     * @param {number} taxableIncome - Adjusted Gross Income
     * @returns {number} Effective tax rate as a percentage (0-100)
     */
    function getEffectiveTaxRate(taxableIncome) {
      // Handle edge cases
      if (taxableIncome <= 0) return 0;
      if (taxableIncome >= 200000) return EFFECTIVE_TAX_RATES[200000];

      // Find the two closest taxable income levels for interpolation
      const taxableIncomeLevels = Object.keys(EFFECTIVE_TAX_RATES)
        .map(Number)
        .sort((a, b) => a - b);

      // Find exact match
      if (EFFECTIVE_TAX_RATES[taxableIncome] !== undefined) {
        return EFFECTIVE_TAX_RATES[taxableIncome];
      }

      // Find interpolation points
      let lowerAgi = 0;
      let upperAgi = 200000;

      for (let i = 0; i < taxableIncomeLevels.length - 1; i++) {
        if (taxableIncome >= taxableIncomeLevels[i] && taxableIncome <= taxableIncomeLevels[i + 1]) {
          lowerAgi = taxableIncomeLevels[i];
          upperAgi = taxableIncomeLevels[i + 1];
          break;
        }
      }

      // Linear interpolation
      const lowerRate = EFFECTIVE_TAX_RATES[lowerAgi];
      const upperRate = EFFECTIVE_TAX_RATES[upperAgi];
      const ratio = (taxableIncome - lowerAgi) / (upperAgi - lowerAgi);

      return lowerRate + (upperRate - lowerRate) * ratio;
    }

    /**
     * Calculate effective tax rate for married filing jointly (approximately 2x the single brackets)
     * @param {number} taxableIncome - Adjusted Gross Income for married couple
     * @returns {number} Effective tax rate as a percentage (0-100)
     */
    function getEffectiveTaxRateMarried(taxableIncome) {
      // For married filing jointly, use the same rates as single but on the full Taxable Income
      // The standard deduction is already doubled in calculateTaxableIncome()
      // The tax brackets for MFJ are roughly 2x single brackets, so rates are similar
      return getEffectiveTaxRate(taxableIncome);
    }

    /**
     * Get tax amount based on gross income and filing status
     * @param {number} grossIncome - Total gross income before standard deduction
     * @param {string} filingStatus - 'single' or 'married'
     * @returns {number} Estimated federal tax amount
     */
    function calculateFederalTax(grossIncome, filingStatus = "single") {
      // First calculate Taxable Income by subtracting standard deduction
      const taxableIncome = calculateTaxableIncome(grossIncome, filingStatus);
      
      // Then get effective rate based on Taxable Income
      const effectiveRate =
        filingStatus === "married"
          ? getEffectiveTaxRateMarried(taxableIncome)
          : getEffectiveTaxRate(taxableIncome);

      // Tax is calculated on the Taxable Income, not gross income
      return taxableIncome * (effectiveRate / 100);
    }

    /**
     * Get marginal tax rate estimate for additional income
     * @param {number} currentGrossIncome - Current gross income
     * @param {number} additionalIncome - Additional income to evaluate
     * @param {string} filingStatus - 'single' or 'married'
     * @returns {number} Estimated marginal tax rate as percentage
     */
    function getMarginalTaxRate(
      currentGrossIncome,
      additionalIncome = 1000,
      filingStatus = "single"
    ) {
      const currentTax = calculateFederalTax(currentGrossIncome, filingStatus);
      const newTax = calculateFederalTax(
        currentGrossIncome + additionalIncome,
        filingStatus
      );

      return ((newTax - currentTax) / additionalIncome) * 100;
    }

    /**
     * Display tax calculation examples for reference
     * @param {string} filingStatus - 'single' or 'married'
     */
    function displayTaxExamples(filingStatus = "single") {
      // console.log(`\n=== Tax Rate Examples (${filingStatus} filer) ===`);
      // console.log(`Standard Deduction: $${STANDARD_DEDUCTIONS[filingStatus].toLocaleString()}`);
      const testGrossIncomes = [25000, 50000, 75000, 100000, 150000, 200000];
      
      testGrossIncomes.forEach(grossIncome => {
        const taxableIncome = calculateTaxableIncome(grossIncome, filingStatus);
        const effectiveRate = filingStatus === "married" 
          ? getEffectiveTaxRateMarried(taxableIncome)
          : getEffectiveTaxRate(taxableIncome);
        const taxAmount = calculateFederalTax(grossIncome, filingStatus);
        const marginalRate = getMarginalTaxRate(grossIncome, 1000, filingStatus);
        
        // console.log(`Gross $${grossIncome.toLocaleString()} → Taxable Income $${taxableIncome.toLocaleString()}: Effective ${effectiveRate.toFixed(1)}%, Tax $${Math.round(taxAmount).toLocaleString()}, Marginal ${marginalRate.toFixed(1)}%`);
      });
      // console.log("=================================\n");
    }

    // Social Security taxation calculation based on provisional income
    function calculateSSTaxableAmount(ssGross, otherTaxableIncome, isMarried = false) {
      if (ssGross <= 0) return 0;
      
      // Calculate provisional income: Taxable Income + non-taxable interest + 50% of SS benefits
      // For simplicity, we'll assume no non-taxable interest
      const provisionalIncome = otherTaxableIncome + (ssGross * 0.5);
      
      // Set thresholds based on filing status
      const threshold1 = isMarried ? 32000 : 25000;  // 0% to 50% transition
      const threshold2 = isMarried ? 44000 : 34000;  // 50% to 85% transition
      
      let taxableAmount = 0;
      
      if (provisionalIncome <= threshold1) {
        // No SS benefits are taxable
        taxableAmount = 0;
      } else if (provisionalIncome <= threshold2) {
        // Up to 50% of SS benefits are taxable
        const excessIncome = provisionalIncome - threshold1;
        taxableAmount = Math.min(ssGross * 0.5, excessIncome * 0.5);
      } else {
        // Up to 85% of SS benefits are taxable
        const tier1Max = (threshold2 - threshold1) * 0.5; // Max from first tier
        const excessIncome = provisionalIncome - threshold2;
        const tier2Amount = Math.min(ssGross * 0.35, excessIncome * 0.85); // Additional 35% (85% - 50%)
        taxableAmount = Math.min(ssGross * 0.85, tier1Max + tier2Amount);
      }
      
      return taxableAmount;
    }

    // Required Minimum Distribution (RMD) calculation
    // Based on IRS Uniform Lifetime Table for 2024+
    function calculateRMD(age, accountBalance) {
      if (age < 73 || accountBalance <= 0) return 0;
      
      // IRS Uniform Lifetime Table (simplified version for common ages)
      const lifeFactor = {
        73: 26.5, 74: 25.5, 75: 24.6, 76: 23.7, 77: 22.9, 78: 22.0, 79: 21.1,
        80: 20.2, 81: 19.4, 82: 18.5, 83: 17.7, 84: 16.8, 85: 16.0, 86: 15.2,
        87: 14.4, 88: 13.7, 89: 12.9, 90: 12.2, 91: 11.5, 92: 10.8, 93: 10.1,
        94: 9.5, 95: 8.9, 96: 8.4, 97: 7.8, 98: 7.3, 99: 6.8, 100: 6.4
      };
      
      // For ages beyond 100, use declining factors
      let factor;
      if (age <= 100) {
        factor = lifeFactor[age] || lifeFactor[100];
      } else {
        // Linear decline after 100
        factor = Math.max(1.0, lifeFactor[100] - (age - 100) * 0.1);
      }
      
      return accountBalance / factor;
    }

    // Helper function to create reusable help icon
    function createHelpIcon(fieldId) {
      return `<svg xmlns="http://www.w3.org/2000/svg" 
                   viewBox="0 0 24 24" 
                   width="1em" height="1em" 
                   fill="#7c8db5" 
                   class="help-icon"
                   onclick="showHelpToast(event, '${fieldId}')"
                   style="vertical-align: middle; margin-left: 0.3em;">
                <circle cx="12" cy="12" r="10" stroke="#7c8db5" stroke-width="2" fill="none"/>
                <path d="M9.5 9a2.5 2.5 0 0 1 5 0c0 1.5-2.5 2-2.5 3.5v1" stroke="#7c8db5" stroke-width="2" fill="none" stroke-linecap="round"/>
                <circle cx="12" cy="17" r="1" fill="#7c8db5"/>
              </svg>`;
    }

    // Help toast functionality
    let currentToast = null;
    let currentProgressBar = null;
    let toastTimer = null;
    let progressTimer = null;

    function showHelpToast(event, fieldId) {
      // Prevent the click from bubbling up to document
      event.stopPropagation();
      
      const helpTexts = {
        currentAge: {
          title: "Current Age",
          body: "Enter your current age in years. This is used as the starting point for all retirement calculations and determines how many years you have until retirement."
        },
        retireAge: {
          title: "Retirement Age",
          body: "The age at which you plan to retire and stop working. This determines when you'll begin withdrawing from your retirement accounts."
        },
        endAge: {
          title: "Plan to Age",
          body: "The age until which you want your retirement funds to last. This is typically your expected lifespan or when you want financial security to end."
        },
        inflation: {
          title: "Inflation Rate",
          body: "The expected annual inflation rate as a percentage. This affects how your spending needs will grow over time and reduces the purchasing power of money."
        },
        spendingToday: {
          title: "Retirement Spending",
          body: "How much you expect to spend per year in retirement, expressed in today's dollars. This will be adjusted for inflation to your retirement date."
        },
        spendingDecline: {
          title: "Annual Spending Decline",
          body: "The percentage by which your spending decreases each year in retirement. Many retirees spend less as they age due to reduced activity and travel."
        },
        spouseAge: {
          title: "Spouse Current Age",
          body: "Your spouse's current age in years. Set to 0 if you don't have a spouse. This affects Social Security and pension benefit calculations."
        },
        spouseRetireAge: {
          title: "Spouse Retirement Age",
          body: "The age at which your spouse plans to retire. This determines when spouse income sources will begin or end."
        },
        salary: {
          title: "Current Salary",
          body: "Your current annual gross salary before taxes and deductions. This is used to calculate retirement contributions and employer matching."
        },
        salaryGrowth: {
          title: "Salary Growth Rate",
          body: "The expected annual percentage increase in your salary. This affects future contribution amounts and employer matching over time."
        },
        pretaxPct: {
          title: "Pre-tax Contribution Rate",
          body: "The percentage of your salary contributed to pre-tax retirement accounts like traditional 401(k) or IRA. These reduce current taxes but are taxed in retirement."
        },
        rothPct: {
          title: "Roth Contribution Rate",
          body: "The percentage of your salary contributed to Roth accounts. These are made with after-tax dollars but grow tax-free and are not taxed in retirement."
        },
        taxablePct: {
          title: "Taxable Savings Rate",
          body: "The percentage of your salary saved in regular taxable investment accounts. These provide flexibility but don't have tax advantages. Note: Interest and dividends earned on these accounts are included in your taxable income each year during working years."
        },
        matchCap: {
          title: "Employer Match Cap",
          body: "The maximum percentage of salary that your employer will match. For example, if your employer matches up to 4% of salary."
        },
        matchRate: {
          title: "Employer Match Rate",
          body: "The percentage rate at which your employer matches contributions. For example, 50% means they contribute $0.50 for every $1.00 you contribute."
        },
        balPre: {
          title: "Pre-tax Balance",
          body: "Your current balance in pre-tax retirement accounts like traditional 401(k), 403(b), or traditional IRA."
        },
        balRoth: {
          title: "Roth Balance",
          body: "Your current balance in Roth retirement accounts like Roth 401(k) or Roth IRA. These grow tax-free."
        },
        balSavings: {
          title: "Taxable Balance",
          body: "Your current balance in regular taxable investment accounts like brokerage accounts, savings, or CDs."
        },
        retPre: {
          title: "Pre-tax Return Rate",
          body: "The expected annual return on your pre-tax retirement investments, expressed as a percentage. Typically 6-8% for diversified portfolios."
        },
        retRoth: {
          title: "Roth Return Rate",
          body: "The expected annual return on your Roth retirement investments. Usually similar to pre-tax returns since they're often in similar investments."
        },
        retTax: {
          title: "Taxable Return Rate",
          body: "The expected annual return on your taxable investments. May be slightly lower due to tax drag from annual taxes on dividends and capital gains."
        },
        ssMonthly: {
          title: "Social Security Benefit",
          body: "Your estimated monthly Social Security benefit in the first year you claim it, in today's dollars. Check your Social Security statement for estimates."
        },
        ssStart: {
          title: "Social Security Start Age",
          body: "The age at which you plan to start claiming Social Security benefits. You can claim as early as 62 or delay until 70 for larger benefits."
        },
        ssCola: {
          title: "Social Security COLA",
          body: "The annual cost-of-living adjustment for Social Security, typically around 2-3% per year to keep pace with inflation."
        },
        penMonthly: {
          title: "Pension Benefit",
          body: "Your estimated monthly pension benefit in the first year you receive it. Set to 0 if you don't have a pension."
        },
        penStart: {
          title: "Pension Start Age",
          body: "The age at which you'll begin receiving pension benefits. This varies by employer and plan type."
        },
        penCola: {
          title: "Pension COLA",
          body: "The annual cost-of-living adjustment for your pension. Many pensions have no COLA (0%), while others may match inflation."
        },
        taxPre: {
          title: "Pre-tax Withdrawal Tax Rate",
          body: "The baseline effective tax rate on withdrawals from pre-tax retirement accounts. The calculator uses Taxable Income-based rates for more accuracy when total income is significant, but falls back to this rate as a minimum."
        },
        taxTaxable: {
          title: "Taxable Withdrawal Tax Rate",
          body: "The effective tax rate on withdrawals from taxable accounts. Usually lower than income tax due to capital gains treatment."
        },
        taxRoth: {
          title: "Roth Withdrawal Tax Rate",
          body: "The effective tax rate on Roth withdrawals. Typically 0% since Roth withdrawals are tax-free in retirement."
        },
        taxSS: {
          title: "Social Security Tax Rate",
          body: "The effective tax rate on Social Security benefits. Varies based on total income, typically 0-18.5% of benefits."
        },
        taxPension: {
          title: "Pension Tax Rate",
          body: "The baseline effective tax rate on pension benefits. When Taxable Income-based calculation is enabled, the calculator uses progressive tax rates based on total income, but falls back to this rate as a minimum. Usually taxed as ordinary income at your marginal tax rate."
        },
        order: {
          title: "Withdrawal Order Strategy",
          body: "The order in which you'll withdraw from different account types. The default strategy withdraws from taxable first, then pre-tax, then Roth to optimize taxes."
        },
        useAgiTax: {
          title: "Taxable Income-Based Tax Calculation",
          body: "When enabled, uses a progressive tax table based on Adjusted Gross Income (gross income minus standard deduction) for pre-tax withdrawals and pension income. Uses 2025 standard deductions: $15,000 (single) / $32,600 (married). This typically results in more accurate tax rates than fixed percentages, especially for larger withdrawal amounts. Check the browser console for detailed calculations showing gross income → Taxable Income → tax rates."
        },
        filingStatus: {
          title: "Tax Filing Status",
          body: "Your tax filing status affects Social Security taxation thresholds and Taxable Income-based tax calculations. Single filers have lower thresholds for SS taxation than married filing jointly."
        },
        useSSRules: {
          title: "Proper Social Security Taxation",
          body: "When enabled, uses actual IRS rules for Social Security taxation based on 'provisional income' rather than simple fixed percentages. SS taxation depends on your total income and can range from 0% to 85% of benefits being taxable."
        },
        useRMD: {
          title: "Required Minimum Distribution Rules",
          body: "When enabled, enforces mandatory withdrawals from pre-tax retirement accounts (401k, traditional IRA) starting at age 73. RMD amounts are calculated based on IRS life expectancy tables and account balances. These withdrawals are required by law and failure to take them results in significant penalties."
        }
      };

      const helpData = helpTexts[fieldId];
      if (!helpData) {
        return;
      }

      // Remove existing toast if any
      if (currentToast) {
        hideToast(true); // Immediate cleanup when replacing
      }

      // Create toast element
      const toast = document.createElement('div');
      toast.className = 'toast';
      toast.innerHTML = `
        <div class="toast-title">${helpData.title}</div>
        <div class="toast-body">${helpData.body}</div>
        <div class="progress-bar"></div>
      `;

      document.body.appendChild(toast);
      currentToast = toast;
      
      const progressBar = toast.querySelector('.progress-bar');
      currentProgressBar = progressBar;

      // Show toast with animation
      progressTimer = setTimeout(() => {
        toast.classList.add('show');
        
        // Initialize progress bar to full width without transition
        progressBar.style.transition = 'none';
        progressBar.style.width = '100%';
        
        // After a brief moment, enable transition and start countdown
        setTimeout(() => {
          progressBar.style.transition = 'width 10000ms linear';
          progressBar.style.width = '0%';
        }, 50);
      }, 10);

      // Auto-hide after 10 seconds
      toastTimer = setTimeout(() => hideToast(), 10000);
    }

    function hideToast(immediate = false) {
      if (!currentToast) return;
      
      // Clear any existing timers
      if (toastTimer) {
        clearTimeout(toastTimer);
        toastTimer = null;
      }
      
      currentToast.classList.remove('show');
      
      if (immediate) {
        // Remove immediately for toast replacement
        if (currentToast && currentToast.parentNode) {
          currentToast.parentNode.removeChild(currentToast);
        }
        currentToast = null;
      } else {
        // Wait for animation to complete for natural dismissal
        setTimeout(() => {
          if (currentToast && currentToast.parentNode) {
            currentToast.parentNode.removeChild(currentToast);
          }
          currentToast = null;
        }, 10000);
      }
    }

    // Generic toast notification function
    function showToast(title, message, type = 'info', duration = 5000) {
      // Remove existing toast if any
      if (currentToast) {
        hideToast(true); // Immediate cleanup when replacing
      }

      // Create toast element
      const toast = document.createElement('div');
      toast.className = `toast toast-${type}`;
      toast.innerHTML = `
        <div class="toast-title">${title}</div>
        <div class="toast-body">${message}</div>
        <div class="progress-bar"></div>
      `;

      document.body.appendChild(toast);
      currentToast = toast;
      
      const progressBar = toast.querySelector('.progress-bar');
      currentProgressBar = progressBar;

      // Show toast with animation
      progressTimer = setTimeout(() => {
        toast.classList.add('show');
        
        // Initialize progress bar to full width without transition
        progressBar.style.transition = 'none';
        progressBar.style.width = '100%';
        
        // After a brief moment, enable transition and start countdown
        setTimeout(() => {
          progressBar.style.transition = `width ${duration}ms linear`;
          progressBar.style.width = '0%';
        }, 50);
      }, 10);

      // Auto-hide after specified duration
      toastTimer = setTimeout(() => hideToast(), duration);
    }

    // Event listeners for dismissing toast
    document.addEventListener('click', (e) => {
      if (currentToast && !currentToast.contains(e.target) && !e.target.closest('.help-icon')) {
        hideToast();
      }
    });

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && currentToast) {
        hideToast();
      }
      
      // Calculate button shortcut: Ctrl+Enter (or Cmd+Enter on Mac)
      if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
        e.preventDefault();
        calc();
      }
    });

    // Annual Spending Details Functions
    function regenerateSpendingFields() {
      const retireAge = num('retireAge');
      const endAge = num('endAge');
      
      // Only generate if ages are valid
      if (retireAge <= 0 || endAge <= retireAge) {
        return;
      }

      const grid = document.getElementById('spendingDetailsGrid');
      grid.innerHTML = ''; // Clear existing fields

      // Generate input fields for each retirement year
      for (let age = retireAge; age <= endAge; age++) {
        const div = document.createElement('div');
        div.innerHTML = `
          <label for="spending_${age}">Age ${age} spending ($)</label>
          <input id="spending_${age}" type="number" step="1000" placeholder="Auto" />
        `;
        grid.appendChild(div);
        
        // Add event listener for inflation adjustment
        const field = document.getElementById(`spending_${age}`);
        field.addEventListener('blur', (event) => handleSpendingFieldChange(age, event));
      }
    }

    function getSpendingOverride(age) {
      const field = document.getElementById(`spending_${age}`);
      if (field && field.value && !isNaN(field.value)) {
        const useCurrentYear = document.getElementById('useCurrentYearValues').checked;
        const fieldValue = Number(field.value);
        
        // console.log(`getSpendingOverride(${age}): fieldValue=${fieldValue}, useCurrentYear=${useCurrentYear}`);
        
        if (useCurrentYear) {
          // If in current year mode, check if we have a stored current year value
          const storedCurrentYearValue = field.getAttribute('data-current-year-value');
          if (storedCurrentYearValue && !isNaN(storedCurrentYearValue)) {
            // Use the stored current year value and apply inflation
            const inflatedValue = applyInflationToSpendingValue(Number(storedCurrentYearValue), age);
            // console.log(`  Using stored current year value ${storedCurrentYearValue} → inflated ${inflatedValue}`);
            return inflatedValue;
          } else {
            // Treat the field value as current year value and apply inflation
            const inflatedValue = applyInflationToSpendingValue(fieldValue, age);
            // console.log(`  Using field value as current year ${fieldValue} → inflated ${inflatedValue}`);
            return inflatedValue;
          }
        } else {
          // Return the field value as-is (already in future dollars)
          // console.log(`  Using field value as future dollars: ${fieldValue}`);
          return fieldValue;
        }
      }
      // console.log(`getSpendingOverride(${age}): No override (field empty or invalid)`);
      return null; // No override specified
    }

    function setSpendingFieldValue(age, value) {
      const field = document.getElementById(`spending_${age}`);
      if (field) {
        field.placeholder = `Auto`;
      }
    }

    function applyInflationToSpendingValue(currentYearValue, targetAge) {
      if (!currentYearValue) return 0;
      const currentAge = parseInt(document.getElementById('currentAge').value) || 0;
      const yearsFromNow = targetAge - currentAge;
      const inflationRate = parseFloat(document.getElementById('inflation').value) / 100 || 0.025;
      return currentYearValue * Math.pow(1 + inflationRate, yearsFromNow);
    }

    function handleSpendingFieldChange(age, event) {
      const useCurrentYear = document.getElementById('useCurrentYearValues').checked;
      const inputValue = parseFloat(event.target.value) || 0;
      
      if (useCurrentYear && inputValue > 0) {
        // Store the current year value but don't change the field value
        // The user sees what they typed, but we store it for inflation calculation
        event.target.setAttribute('data-current-year-value', inputValue);
        
        // Calculate and show what the inflated value would be in the tooltip
        const inflatedValue = applyInflationToSpendingValue(inputValue, age);
        event.target.setAttribute('title', `Current year value: $${inputValue.toLocaleString()} → Inflated to age ${age}: $${inflatedValue.toLocaleString()}`);
      } else if (!useCurrentYear) {
        // In future dollar mode, clear any stored current year value
        event.target.removeAttribute('data-current-year-value');
        event.target.removeAttribute('title');
      }
      
      // Trigger recalculation
      calc();
    }

    function updateSpendingFieldsDisplayMode() {
      const useCurrentYear = document.getElementById('useCurrentYearValues').checked;
      const retireAge = num('retireAge');
      const endAge = num('endAge');
      
      if (retireAge <= 0 || endAge <= retireAge) return;
      
      for (let age = retireAge; age <= endAge; age++) {
        const field = document.getElementById(`spending_${age}`);
        if (!field) continue;
        
        const currentValue = parseFloat(field.value) || 0;
        const storedCurrentYearValue = parseFloat(field.getAttribute('data-current-year-value')) || 0;
        
        if (useCurrentYear) {
          // Switch to current year mode
          field.placeholder = 'Current year $';
          
          if (currentValue > 0 && !storedCurrentYearValue) {
            // When switching to current year mode, assume the current field value 
            // is already in current year dollars (user entered it as such)
            // Store it as the current year value without conversion
            field.setAttribute('data-current-year-value', currentValue);
          }
          
          // Update tooltip to show inflation calculation
          if (field.value && !isNaN(field.value)) {
            const displayValue = parseFloat(field.value);
            const inflatedValue = applyInflationToSpendingValue(displayValue, age);
            field.setAttribute('title', `Current year value: $${displayValue.toLocaleString()} → Inflated to age ${age}: $${inflatedValue.toLocaleString()}`);
          }
        } else {
          // Switch to inflated mode
          field.placeholder = 'Future $';
          
          // Don't change the field value - let the user keep what they typed
          // Just clear the stored current year value and tooltips
          field.removeAttribute('data-current-year-value');
          field.removeAttribute('title');
        }
      }
      
      calc();
    }
  
    function loadExample(){
      const ex = {
        currentAge: 60, retireAge: 62, endAge: 90, inflation: 0.0, 
        spendingToday: 95000, spendingDecline: 0.0,
        spouseAge: 56, spouseRetireAge: 62, 
        spouseSsMonthly: 1000, spouseSsStart: 66, spouseSsCola: 0.0,
        spousePenMonthly: 500, spousePenStart: 69, spousePenCola: 0, 
        spouseTaxSS: 10, spouseTaxPension: 20,
        salary: 170000, salaryGrowth: 2.0, pretaxPct: 0, rothPct: 0, taxablePct: 35,
        matchCap: 0, matchRate: 0, 
        balPre: 600000, balRoth: 0, balSavings: 500000,
        retPre: 3.0, retRoth: 0.0, retTax: 3.0, 
        ssMonthly: 2500, ssStart: 62, ssCola: 0.0,
        penMonthly: 3500, penStart: 65, penCola: 0, taxPre: 15, taxTaxable: 0, taxRoth: 0,
        taxSS: 10, taxPension: 15, order: 'pretax,taxable,roth',
        filingStatus: 'married', useAgiTax: true, useSSRules: true, useRMD: true
      };
      // const ex = {
      //   currentAge:55, retireAge:65, endAge:85, inflation:2.5, spendingToday:60000, spendingDecline:1.0,
      //   spouseAge:52, spouseRetireAge:62, spouseSsMonthly:1000, spouseSsStart:62, spouseSsCola:2.0,
      //   spousePenMonthly:500, spousePenStart:65, spousePenCola:0, spouseTaxSS:10, spouseTaxPension:20,
      //   salary:100000, salaryGrowth:3.0, pretaxPct:10, rothPct:5, taxablePct:5,
      //   matchCap:4, matchRate:50, balPre:300000, balRoth:100000, balSavings:50000,
      //   retPre:6.0, retRoth:6.0, retTax:5.5, ssMonthly:2500, ssStart:67, ssCola:2.0,
      //   penMonthly:0, penStart:65, penCola:0, taxPre:22, taxTaxable:10, taxRoth:0,
      //   taxSS:10, taxPension:20, order:'taxable,pretax,roth'
      // };
      // const ex = {
      //   currentAge: 54, retireAge: 55, endAge: 85, 
      //   inflation: 0.0, spendingToday: 50000, spendingDecline: 0.0,
      //   spouseAge: 52, spouseRetireAge: 62, spouseSsMonthly: 0, spouseSsStart: 62, spouseSsCola: 2.0,
      //   spousePenMonthly: 0, spousePenStart: 65, spousePenCola: 0, spouseTaxSS: 10, spouseTaxPension: 20,
      //   salary: 0, salaryGrowth: 3.0, pretaxPct: 10, rothPct: 5, taxablePct: 5,
      //   matchCap: 4, matchRate: 50, balPre: 1000000, balRoth: 0, balSavings: 0,
      //   retPre: 0.0, retRoth: 0.0, retTax: 0.0, 
      //   ssMonthly: 0, ssStart: 67, ssCola: 2.0,
      //   penMonthly: 0, penStart: 65, penCola: 0, 
      //   taxPre: 0, taxTaxable: 0, taxRoth: 0,
      //   taxSS: 0, taxPension: 0, order: 'pretax,roth,taxable'
      // };
      for(const [k,v] of Object.entries(ex)){ if($(k)) $(k).value = v; }
    }

    function resetAll(){
      document.querySelectorAll('input').forEach(i=> i.value = i.defaultValue ?? '');
      $('order').value = 'taxable,pretax,roth';
      $('filingStatus').value = 'single';
      
      // Clear spending override fields
      const grid = document.getElementById('spendingDetailsGrid');
      grid.innerHTML = '';
      
      $('rows').innerHTML = '';
      $('kpiAge').textContent = '—';
      $('kpiEndBal').textContent = '—';
      $('kpiDraw').textContent = '—';
      $('kpiTax').textContent = '—';
      drawChart([]);
    }

    /**
     * Parse and validate input parameters for the retirement calculation
     */
    function parseInputParameters() {
      // Basic parameters
      const params = {
        currentAge: num('currentAge'),
        retireAge: num('retireAge'),
        endAge: num('endAge'),
        inflation: pct(num('inflation')),
        spendingToday: num('spendingToday'),
        spendingDecline: pct(num('spendingDecline')),
        
        // Spouse information
        spouseAge: num('spouseAge'),
        spouseRetireAge: num('spouseRetireAge'),
        spouseSsMonthly: num('spouseSsMonthly'),
        spouseSsStart: num('spouseSsStart'),
        spouseSsCola: pct(num('spouseSsCola')),
        spousePenMonthly: num('spousePenMonthly'),
        spousePenStart: num('spousePenStart'),
        spousePenCola: pct(num('spousePenCola')),
        spouseTaxSS: pct(num('spouseTaxSS')),
        spouseTaxPension: pct(num('spouseTaxPension')),
        
        // Employment and contributions
        startingSalary: num('salary'),
        salaryGrowth: pct(num('salaryGrowth')),
        pretaxPct: pct(num('pretaxPct')),
        rothPct: pct(num('rothPct')),
        taxablePct: pct(num('taxablePct')),
        matchCap: pct(num('matchCap')),
        matchRate: pct(num('matchRate')),
        
        // Account balances and returns
        balPre: num('balPre'),
        balRoth: num('balRoth'),
        balSavings: num('balSavings'),
        retPre: pct(num('retPre')),
        retRoth: pct(num('retRoth')),
        retTax: pct(num('retTax')),
        
        // Income sources
        ssMonthly: num('ssMonthly'),
        ssStart: num('ssStart'),
        ssCola: pct(num('ssCola')),
        penMonthly: num('penMonthly'),
        penStart: num('penStart'),
        penCola: pct(num('penCola')),
        
        // Tax rates and settings
        taxPre: pct(num('taxPre')),
        taxTaxable: pct(num('taxTaxable')),
        taxRoth: pct(num('taxRoth')),
        taxSS: pct(num('taxSS')),
        taxPension: pct(num('taxPension')),
        filingStatus: $('filingStatus').value,
        useAgiTax: $('useAgiTax').checked,
        useSSRules: $('useSSRules').checked,
        useRMD: $('useRMD').checked
      };
      
      // Parse withdrawal order
      params.order = $('order').value.split(',').map(s => s.trim()).filter(s => s.length > 0);
      if (params.order.length === 0) {
        params.order = ['taxable', 'pretax', 'roth'];
        // console.log('Using fallback withdrawal order:', params.order);
      }
      
      // Derived values
      params.hasSpouse = params.spouseAge > 0;
      params.yearsToRetire = params.retireAge - params.currentAge;
      params.yearsTotal = params.endAge - params.currentAge;
      params.spendAtRetire = params.spendingToday * pow1p(params.inflation, params.yearsToRetire);
      
      return params;
    }
    
    /**
     * Validate that the input parameters are valid
     */
    function validateInputs(params) {
      if (params.retireAge <= params.currentAge || params.endAge <= params.retireAge) {
        showToast('Invalid Ages', 'Please ensure: current age < retirement age < plan age.', 'error');
        return false;
      }
      return true;
    }
    
    /**
     * Calculate one year of accumulation phase (working years)
     */
    function calculateWorkingYearData(params, year, salary, balances) {
      const age = params.currentAge + year;
      
      // Calculate current year living expenses (retirement spending adjusted to current year)
      const currentYearSpending = params.spendingToday * pow1p(params.inflation, year);
      
      // Desired contributions this year
      let desiredPre = salary * params.pretaxPct;
      let desiredRoth = salary * params.rothPct;
      
      // 401k/Roth 401k elective deferral cap (employee-only)
      let electiveLimit = EMPLOYEE_401K_LIMIT_2025 + (age >= 50 ? EMPLOYEE_401K_CATCHUP_50 : 0);
      const totalDesired = desiredPre + desiredRoth;
      let scale = totalDesired > 0 ? Math.min(1, electiveLimit / totalDesired) : 1;
      const cPre = desiredPre * scale;
      const cRoth = desiredRoth * scale;

      // Employer match based on actual pre-tax contribution %, capped by matchCap
      const actualPrePct = salary > 0 ? (cPre / salary) : 0;
      const match = Math.min(actualPrePct, params.matchCap) * salary * params.matchRate;

      // Calculate taxes on working income including taxable interest
      const taxableInterestIncome = balances.balSavings * params.retTax;
      let grossTaxableIncome = salary - cPre + taxableInterestIncome;
      
      const workingYearTaxes = params.useAgiTax ? 
        calculateFederalTax(grossTaxableIncome, params.filingStatus) : 
        grossTaxableIncome * params.taxPre;
      
      // Debug tax calculation for first few years
      if (year < 3) {
        // console.log(`\n=== WORKING YEAR TAX DEBUG (Year ${year + 1}, Age ${age}) ===`);
        // console.log(`Salary: ${fmt(salary)}`);
        // console.log(`Pre-tax contributions: ${fmt(cPre)}`);
        // console.log(`Taxable balance (start of year): ${fmt(balances.balSavings)}`);
        // console.log(`Taxable interest income: ${fmt(taxableInterestIncome)}`);
        // console.log(`Gross Taxable Income: ${fmt(grossTaxableIncome)}`);
        // console.log(`Filing Status: ${params.filingStatus}`);
        // console.log(`Use Taxable Income Tax: ${params.useAgiTax}`);
        if (params.useAgiTax) {
          const taxableIncomeAfterDeduction = calculateTaxableIncome(grossTaxableIncome, params.filingStatus);
          const effectiveRate = params.filingStatus === "married" 
            ? getEffectiveTaxRateMarried(taxableIncomeAfterDeduction)
            : getEffectiveTaxRate(taxableIncomeAfterDeduction);
          // console.log(`Taxable Income (after standard deduction): ${fmt(taxableIncomeAfterDeduction)}`);
          // console.log(`Effective Tax Rate: ${effectiveRate.toFixed(1)}%`);
          // console.log(`Calculated Federal Tax: ${fmt(workingYearTaxes)}`);
        } else {
          // console.log(`Using fixed tax rate: ${(params.taxPre * 100).toFixed(1)}%`);
          // console.log(`Calculated Tax: ${fmt(workingYearTaxes)}`);
        }
        // console.log(`=== END TAX DEBUG ===\n`);
      }
      
      // After-tax income calculations
      const afterTaxIncome = salary - cPre - workingYearTaxes - cRoth;
      const availableForSpendingAndSavings = afterTaxIncome;
      const remainingAfterSpending = Math.max(0, availableForSpendingAndSavings - currentYearSpending);
      const desiredTaxableSavings = salary * params.taxablePct;
      const cTax = Math.min(desiredTaxableSavings, remainingAfterSpending);
      
      // Debug working year calculations (show for first few years)
      if (year < 3) {
        // console.log(`Working Year ${year + 1} (Age ${age}):`);
        // console.log(`  Salary: ${fmt(salary)}`);
        // console.log(`  Pre-tax contrib: ${fmt(cPre)} | Roth contrib: ${fmt(cRoth)}`);
        // console.log(`  Taxable interest income: ${fmt(taxableInterestIncome)}`);
        // console.log(`  Gross taxable income: ${fmt(grossTaxableIncome)} | Taxes: ${fmt(workingYearTaxes)}`);
        // console.log(`  After-tax income: ${fmt(afterTaxIncome)}`);
        // console.log(`  Living expenses: ${fmt(currentYearSpending)}`);
        // console.log(`  Remaining for savings: ${fmt(remainingAfterSpending)}`);
        // console.log(`  Desired taxable savings: ${fmt(desiredTaxableSavings)} | Actual: ${fmt(cTax)}`);
        if (cTax < desiredTaxableSavings) {
          // console.log(`  ⚠️ Savings limited by available income (shortfall: ${fmt(desiredTaxableSavings - cTax)})`);
        }
      }

      // Update balances
      balances.balPre = (balances.balPre + cPre + match) * (1 + params.retPre);
      balances.balRoth = (balances.balRoth + cRoth) * (1 + params.retRoth);
      balances.balSavings = (balances.balSavings + cTax) * (1 + params.retTax);

      return {
        age,
        salary,
        contrib: cPre + cRoth + cTax + match,
        ss: 0, pen: 0, spouseSs: 0, spousePen: 0, 
        spend: currentYearSpending,
        wNet: 0, wGross: 0,
        w401kGross: 0, wSavingsGross: 0, wRothGross: 0,
        taxes: workingYearTaxes,
        ssTaxes: 0,
        otherTaxes: workingYearTaxes,
        nonTaxableIncome: 0, // No non-taxable income during working years
        taxableIncome: grossTaxableIncome, // Working year taxable income
        taxableInterest: taxableInterestIncome, // Track taxable interest earned
        effectiveTaxRate: grossTaxableIncome > 0 ? (workingYearTaxes / grossTaxableIncome) * 100 : 0,
        balSavings: balances.balSavings, 
        balPre: balances.balPre, 
        balRoth: balances.balRoth,
        total: balances.balSavings + balances.balPre + balances.balRoth
      };
    }

    function calc(){
      // Enhanced retirement calculator with realistic working year modeling
      const params = parseInputParameters();
      
      if (!validateInputs(params)) {
        return;
      }

      // Auto-regenerate spending override fields only if ages have changed
      if (params.retireAge > 0 && params.endAge > params.retireAge && 
          (lastRetireAge !== params.retireAge || lastEndAge !== params.endAge)) {
        regenerateSpendingFields();
        lastRetireAge = params.retireAge;
        lastEndAge = params.endAge;
      }

      // Display enhanced tax calculation examples
      if (params.useAgiTax) {
        displayTaxExamples(params.filingStatus);
      }

      // Initialize balances object for tracking
      const balances = {
        balPre: params.balPre,
        balRoth: params.balRoth,
        balSavings: params.balSavings
      };

      const calculations = [];

      let currentSalary = params.startingSalary;
      let totalTaxes = 0;
      let maxDrawdown = { year: null, value: Infinity };
      
      
      // Working years
      for(let y = 0; y < params.yearsToRetire; y++){
        const yearData = calculateWorkingYearData(params, y, currentSalary, balances);
        
        calculations.push({
          year: new Date().getFullYear() + y,
          ...yearData
        });

        // Track total taxes paid during working years
        totalTaxes += yearData.taxes;

        // Update salary for next year
        currentSalary *= (1 + params.salaryGrowth);
      }

      // console.log('Working years: ', calculations);

      /**
       * Calculate spouse benefit amounts at the time of primary person's retirement
       */
      function calculateSpouseBenefits(params) {
        let spouseSsAnnual = 0;
        let spousePenAnnual = 0;
        
        if (params.hasSpouse) {
          const spouseCurrentYear = params.retireAge - params.currentAge; // Years from now when primary person retires
          const spouseAgeAtPrimaryRetirement = params.spouseAge + spouseCurrentYear;
          
          spouseSsAnnual = params.spouseSsMonthly * 12 * (spouseAgeAtPrimaryRetirement >= params.spouseSsStart ? 
            pow1p(params.spouseSsCola, spouseAgeAtPrimaryRetirement - params.spouseSsStart) : 1);
          spousePenAnnual = params.spousePenMonthly * 12 * (spouseAgeAtPrimaryRetirement >= params.spousePenStart ? 
            pow1p(params.spousePenCola, spouseAgeAtPrimaryRetirement - params.spousePenStart) : 1);
        }
      
        return { spouseSsAnnual, spousePenAnnual };
      }
    
      /**
       * Calculate Social Security taxation for a given year
       */
      function calculateSocialSecurityTaxation(params, ssGross, totalTaxableIncome) {
        if (!ssGross || ssGross <= 0) {
          return { ssNet: 0, ssTaxableAmount: 0, ssNonTaxable: 0, ssTaxes: 0 };
        }
        
        const isMarried = params.filingStatus === 'married';
        
        if (params.useSSRules) {
          // Use proper SS taxation rules based on provisional income
          const ssTaxableAmount = calculateSSTaxableAmount(ssGross, totalTaxableIncome, isMarried);
          const ssNonTaxable = ssGross - ssTaxableAmount;
          const grossIncomeForTax = totalTaxableIncome + ssTaxableAmount;
          const effectiveRate = isMarried 
            ? getEffectiveTaxRateMarried(calculateTaxableIncome(grossIncomeForTax, "married"))
            : getEffectiveTaxRate(calculateTaxableIncome(grossIncomeForTax, "single"));
          const ssTaxes = ssTaxableAmount * (effectiveRate / 100);
          const ssNet = ssGross - ssTaxes;
          // console.log(`SS: Gross $${ssGross.toLocaleString()}, Taxable $${ssTaxableAmount.toLocaleString()}, Non-Taxable $${ssNonTaxable.toLocaleString()}, Tax $${ssTaxes.toLocaleString()}, Net $${ssNet.toLocaleString()}`);
          return { ssNet, ssTaxableAmount, ssNonTaxable, ssTaxes };
        } else {
          // Use simple fixed percentage method
          const ssTaxableAmount = ssGross * 0.85;
          const ssNonTaxable = ssGross * 0.15; // 15% is non-taxable
          const grossIncomeForTax_simple = totalTaxableIncome + ssTaxableAmount;
          const effRate_simple = isMarried 
            ? getEffectiveTaxRateMarried(calculateTaxableIncome(grossIncomeForTax_simple, "married"))
            : getEffectiveTaxRate(calculateTaxableIncome(grossIncomeForTax_simple, "single"));
          const ssTaxes = ssTaxableAmount * (effRate_simple / 100);
          const ssNet = ssGross - ssTaxes;
          return { ssNet, ssTaxableAmount, ssNonTaxable, ssTaxes };
        }
      }
      
      /**
       * Calculate pension taxation for a given year
       */
      function calculatePensionTaxation(params, penGross, totalTaxableIncome) {
        if (!penGross || penGross <= 0) {
          return { penNet: 0, penTaxes: 0, penTaxableAmount: 0, penNonTaxable: 0, pensionTaxRate: 0 };
        }
        
        // Pensions are typically fully taxable, but we track for consistency
        const penTaxableAmount = penGross; // 100% taxable
        const penNonTaxable = 0; // 0% non-taxable
        
        let pensionTaxRate = params.taxPension;
        
        if (params.useAgiTax) {
          const grossIncomeForPensionTax = penTaxableAmount + totalTaxableIncome;
          const taxableIncomeForPensionTax = calculateTaxableIncome(grossIncomeForPensionTax, params.filingStatus);
          const taxableIncomeBasedRate = params.filingStatus === "married" 
            ? getEffectiveTaxRateMarried(taxableIncomeForPensionTax)
            : getEffectiveTaxRate(taxableIncomeForPensionTax);
          
          const taxableIncomeRateDecimal = taxableIncomeBasedRate / 100;
          pensionTaxRate = Math.max(params.taxPension, taxableIncomeRateDecimal);
          
          // console.log(`Pension Taxable Income Tax Calc: Gross Income: $${grossIncomeForPensionTax.toLocaleString()}, Taxable Income: $${taxableIncomeForPensionTax.toLocaleString()}, Filing: ${params.filingStatus}, Taxable Income Rate: ${taxableIncomeBasedRate.toFixed(1)}%, Fixed Rate: ${(params.taxPension*100).toFixed(1)}%, Using: ${(pensionTaxRate*100).toFixed(1)}%`);
        }
        
        const penTaxes = penTaxableAmount * pensionTaxRate;
        const penNet = penGross - penTaxes;
        
        return { penNet, penTaxes, penTaxableAmount, penNonTaxable, pensionTaxRate };
      }

      // Setup retirement years; calculate initial benefit amounts
      let ssAnnual = params.ssMonthly * 12 * (params.retireAge >= params.ssStart ? pow1p(params.ssCola, params.retireAge - params.ssStart) : 1);
      let penAnnual = params.penMonthly * 12 * (params.retireAge >= params.penStart ? pow1p(params.penCola, params.retireAge - params.penStart) : 1);
      
      const spouseBenefits = calculateSpouseBenefits(params);
      let spouseSsAnnual = spouseBenefits.spouseSsAnnual;
      let spousePenAnnual = spouseBenefits.spousePenAnnual;
      
      let spend = params.spendAtRetire;

      /**
       * Create withdrawal function for a specific retirement year
       */
      function createWithdrawalFunction(params, balances, totalTaxableIncomeRef) {
        let taxesThisYear = 0;
        let withdrawalsBySource = { pretax: 0, taxable: 0, roth: 0 };
        
        function withdrawFrom(kind, netAmount) {
          // console.log(`withdrawFrom called with kind: "${kind}", netAmount: ${netAmount}`);
          if(netAmount <= 0) return { gross: 0, net: 0 };
          
          // Validate kind parameter
          if (!kind || typeof kind !== 'string') {
            console.error('Invalid withdrawal kind:', kind);
            return { gross: 0, net: 0 };
          }
          
          let fixedTaxRate = 0, balRef = 0, setBal;
          
          if(kind === 'taxable'){ 
            fixedTaxRate = params.taxTaxable; 
            balRef = balances.balSavings; 
            setBal = (v) => { balances.balSavings = v; };
          } else if(kind === 'pretax'){ 
            fixedTaxRate = params.taxPre; 
            balRef = balances.balPre; 
            setBal = (v) => { balances.balPre = v; };
          } else if(kind === 'roth'){   
            fixedTaxRate = params.taxRoth; 
            balRef = balances.balRoth; 
            setBal = (v) => { balances.balRoth = v; };
          } else {
            console.error('Unknown withdrawal kind:', kind);
            return { gross: 0, net: 0 };
          }

          // Use Taxable Income-based calculation for pre-tax withdrawals if enabled
          let taxRate = fixedTaxRate;
          
          if (kind === 'pretax' && params.useAgiTax) {
            const estimatedGrossWithdrawal = netAmount / (1 - fixedTaxRate);
            const projectedGrossIncome = totalTaxableIncomeRef.value + estimatedGrossWithdrawal;
            
            const projectedTaxableIncome = calculateTaxableIncome(projectedGrossIncome, params.filingStatus);
            const taxableIncomeBasedRate = params.filingStatus === "married" 
              ? getEffectiveTaxRateMarried(projectedTaxableIncome)
              : getEffectiveTaxRate(projectedTaxableIncome);
            
            const taxableIncomeRateDecimal = taxableIncomeBasedRate / 100;
            taxRate = Math.max(fixedTaxRate, taxableIncomeRateDecimal);
            
            // console.log(`Gross Income: $${projectedGrossIncome.toLocaleString()}, Taxable Income: $${projectedTaxableIncome.toLocaleString()}, Filing: ${params.filingStatus}, Taxable Income Rate: ${taxableIncomeBasedRate.toFixed(1)}%, Fixed Rate: ${(fixedTaxRate*100).toFixed(1)}%, Using: ${(taxRate*100).toFixed(1)}%`);
          }

          const grossNeeded = netAmount / (1 - taxRate);
          const grossTake = Math.min(grossNeeded, balRef);
          const netReceived = grossTake * (1 - taxRate);
          const taxPaid = grossTake - netReceived;
          setBal(balRef - grossTake);
          taxesThisYear += taxPaid;
          
          // Track withdrawals by source
          withdrawalsBySource[kind] += grossTake;
          
          // Add pre-tax withdrawals to Taxable Income for subsequent calculations
          if (kind === 'pretax') {
            totalTaxableIncomeRef.value += grossTake;
          }
          
          return { gross: grossTake, net: netReceived };
        }
        
        // Special function for RMD withdrawals (gross amount based)
        function withdrawRMD(grossAmount) {
          if (grossAmount <= 0 || balances.balPre <= 0) return { gross: 0, net: 0 };
          
          const actualGross = Math.min(grossAmount, balances.balPre);
          
          let taxRate = params.taxPre;
          
          if (params.useAgiTax) {
            const projectedGrossIncome = totalTaxableIncomeRef.value + actualGross;
            const projectedTaxableIncome = calculateTaxableIncome(projectedGrossIncome, params.filingStatus);
            const taxableIncomeBasedRate = params.filingStatus === "married" 
              ? getEffectiveTaxRateMarried(projectedTaxableIncome)
              : getEffectiveTaxRate(projectedTaxableIncome);
            const taxableIncomeRateDecimal = taxableIncomeBasedRate / 100;
            taxRate = Math.max(params.taxPre, taxableIncomeRateDecimal);
          }
          
          const netReceived = actualGross * (1 - taxRate);
          const taxPaid = actualGross - netReceived;
          balances.balPre -= actualGross;
          taxesThisYear += taxPaid;
          totalTaxableIncomeRef.value += actualGross;
          
          // Track RMD withdrawals as pretax
          withdrawalsBySource.pretax += actualGross;
          
          return { gross: actualGross, net: netReceived };
        }
        
        return { 
          withdrawFrom, 
          withdrawRMD, 
          getTaxesThisYear: () => taxesThisYear,
          getWithdrawalsBySource: () => withdrawalsBySource
        };
      }
      
      /**
       * Calculate a given retirement year with proper SS taxation based on total income
       */
      function calculateRetirementYearData(params, year, balances, benefitAmounts, spend) {
        const age = params.currentAge + year;
        const yearNum = new Date().getFullYear() + year;

        // Income sources (gross amounts)
        const hasSS = age >= params.ssStart;
        const hasPen = age >= params.penStart && params.penMonthly > 0;
        const ssGross = hasSS ? benefitAmounts.ssAnnual : 0;
        const penGross = hasPen ? benefitAmounts.penAnnual : 0;
        
        // Spouse income sources
        let spouseSsGross = 0;
        let spousePenGross = 0;
        
        if (params.hasSpouse) {
          const spouseCurrentAge = params.spouseAge + (age - params.currentAge);
          const hasSpouseSS = spouseCurrentAge >= params.spouseSsStart;
          const hasSpousePen = spouseCurrentAge >= params.spousePenStart && params.spousePenMonthly > 0;
          
          spouseSsGross = hasSpouseSS ? benefitAmounts.spouseSsAnnual : 0;
          spousePenGross = hasSpousePen ? benefitAmounts.spousePenAnnual : 0;
        }

        // Get spending need (with overrides)
        const spendingOverride = getSpendingOverride(age);
        const actualSpend = spendingOverride !== null ? spendingOverride : spend;
        
        if (spendingOverride !== null) {
          // console.log(`Age ${age}: Using override spending $${spendingOverride.toLocaleString()} instead of auto $${spend.toLocaleString()}`);
        }
        
        if (spendingOverride === null) {
          setSpendingFieldValue(age, spend);
        }
        
        // STEP 1: Calculate pension taxation (straightforward - doesn't depend on SS)
        let totalTaxableIncomeRef = { value: penGross + spousePenGross };
        const penResults = calculatePensionTaxation(params, penGross, 0); // Start with no other income
        const spousePenResults = calculatePensionTaxation(params, spousePenGross, penResults.penTaxableAmount);
        
        // Update taxable income reference to include only taxable portions
        totalTaxableIncomeRef.value = penResults.penTaxableAmount + spousePenResults.penTaxableAmount;
        
        // STEP 2: Estimate initial withdrawal need (before SS taxation)
        // Use net amounts (after tax) for spending calculation
        let preliminaryNeedNet = Math.max(0, actualSpend - (penResults.penNet + spousePenResults.penNet));
        
        // STEP 3: Make preliminary withdrawals to estimate total income for SS calculation
        let balancesCopy = { ...balances }; // Work with copy for estimation
        let totalTaxableIncomeCopy = { value: totalTaxableIncomeRef.value };
        
        const preliminaryWithdrawalFunctions = createWithdrawalFunction(params, balancesCopy, totalTaxableIncomeCopy);
        
        // Apply RMDs first (preliminary)
        let preliminaryRmdAmount = 0;
        let preliminaryWGross = 0;
        
        if (params.useRMD && age >= 73) {
          preliminaryRmdAmount = calculateRMD(age, balancesCopy.balPre);
          if (preliminaryRmdAmount > 0) {
            const rmdWithdrawal = preliminaryWithdrawalFunctions.withdrawRMD(preliminaryRmdAmount);
            preliminaryNeedNet = Math.max(0, preliminaryNeedNet - rmdWithdrawal.net);
            preliminaryWGross += rmdWithdrawal.gross;
          }
        }
        
        // Then regular withdrawals (preliminary)
        for(const k of params.order){
          if(preliminaryNeedNet <= 0) break;
          const {gross=0, net=0} = preliminaryWithdrawalFunctions.withdrawFrom(k, preliminaryNeedNet) || {};
          preliminaryNeedNet = Math.max(0, preliminaryNeedNet - net);
          preliminaryWGross += gross;
        }
        
        // STEP 4: Now calculate SS taxation based on total income including withdrawals
        const totalIncomeForSSCalculation = totalTaxableIncomeCopy.value + preliminaryWGross;
        const ssResults = calculateSocialSecurityTaxation(params, ssGross, totalIncomeForSSCalculation);
        const spouseSsResults = calculateSocialSecurityTaxation(params, spouseSsGross, totalIncomeForSSCalculation + ssResults.ssTaxableAmount);
        
        // STEP 5: Recalculate final withdrawals with correct SS net amounts
        // Only include taxable portions in taxable income reference
        totalTaxableIncomeRef.value = penResults.penTaxableAmount + spousePenResults.penTaxableAmount + ssResults.ssTaxableAmount + spouseSsResults.ssTaxableAmount;
        
        // Use full net amounts (including non-taxable portions) for spending calculation
        let finalNeedNet = Math.max(0, actualSpend - (ssResults.ssNet + penResults.penNet + spouseSsResults.ssNet + spousePenResults.penNet));
        
        const finalWithdrawalFunctions = createWithdrawalFunction(params, balances, totalTaxableIncomeRef);
        
        let finalWGross = 0, finalWNet = 0;
        let taxesThisYear = penResults.penTaxes + spousePenResults.penTaxes + ssResults.ssTaxes + spouseSsResults.ssTaxes;
        
        // Apply RMDs (final)
        if (params.useRMD && age >= 73 && preliminaryRmdAmount > 0) {
          const rmdWithdrawal = finalWithdrawalFunctions.withdrawRMD(preliminaryRmdAmount);
          finalNeedNet = Math.max(0, finalNeedNet - rmdWithdrawal.net);
          finalWGross += rmdWithdrawal.gross;
          finalWNet += rmdWithdrawal.net;
          // console.log(`RMD at age ${age}: Required $${preliminaryRmdAmount.toLocaleString()}, Withdrew $${rmdWithdrawal.gross.toLocaleString()} gross, $${rmdWithdrawal.net.toLocaleString()} net`);
        }
        
        // Regular withdrawals (final)
        for(const k of params.order){
          if(finalNeedNet <= 0) break;
          const {gross=0, net=0} = finalWithdrawalFunctions.withdrawFrom(k, finalNeedNet) || {};
          finalNeedNet = Math.max(0, finalNeedNet - net);
          finalWGross += gross;
          finalWNet += net;
        }
        
        // Add withdrawal taxes
        taxesThisYear += finalWithdrawalFunctions.getTaxesThisYear();
        
        // Grow remaining balances
        balances.balSavings *= (1 + params.retTax);
        balances.balPre *= (1 + params.retPre);
        balances.balRoth *= (1 + params.retRoth);
        
        // Calculate taxable interest earned this year (after withdrawals, before growth)
        const taxableInterestEarned = (balances.balSavings / (1 + params.retTax)) * params.retTax;
        
        const totalBal = balances.balSavings + balances.balPre + balances.balRoth;
        const totalGrossIncome = ssGross + penGross + spouseSsGross + spousePenGross + finalWGross;
        const effectiveTaxRate = totalGrossIncome > 0 ? (taxesThisYear / totalGrossIncome) * 100 : 0;
        
        // Track Social Security taxes separately and non-taxable income
        const ssTaxes = ssResults.ssTaxes + spouseSsResults.ssTaxes;
        const otherTaxes = taxesThisYear - ssTaxes;
        const totalNonTaxableIncome = ssResults.ssNonTaxable + spouseSsResults.ssNonTaxable + penResults.penNonTaxable + spousePenResults.penNonTaxable;
        const totalTaxableIncome = penResults.penTaxableAmount + spousePenResults.penTaxableAmount + ssResults.ssTaxableAmount + spouseSsResults.ssTaxableAmount + finalWGross;
        
        // Get withdrawal breakdown by source
        const withdrawalsBySource = finalWithdrawalFunctions.getWithdrawalsBySource();
        
        return {
          year: yearNum, 
          age, 
          salary: 0, 
          contrib: 0,
          ss: ssResults.ssNet, 
          pen: penResults.penNet, 
          spouseSs: spouseSsResults.ssNet, 
          spousePen: spousePenResults.penNet, 
          spend: actualSpend,
          wNet: finalWNet, 
          wGross: finalWGross,
          w401kGross: withdrawalsBySource.pretax,
          wSavingsGross: withdrawalsBySource.taxable,
          wRothGross: withdrawalsBySource.roth,
          taxes: taxesThisYear, 
          ssTaxes: ssTaxes,
          otherTaxes: otherTaxes,
          nonTaxableIncome: totalNonTaxableIncome,
          taxableIncome: totalTaxableIncome,
          taxableInterest: taxableInterestEarned,
          effectiveTaxRate,
          balSavings: balances.balSavings, 
          balPre: balances.balPre, 
          balRoth: balances.balRoth, 
          total: totalBal
        };
      }


      // Retirement years
      for(let y = params.yearsToRetire; y < params.yearsTotal; y++){

          const benefitAmounts = {
            ssAnnual,
            penAnnual,
            spouseSsAnnual,
            spousePenAnnual
          };
          
          const yearData = calculateRetirementYearData(params, y, balances, benefitAmounts, spend);
          calculations.push(yearData);

          

          const totalBal = yearData.total;
          totalTaxes += yearData.taxes;
          if(totalBal < maxDrawdown.value){ 
            maxDrawdown = { year: yearData.year, value: totalBal }; 
          }

          // Step next year: Apply COLAs to benefits
          const age = yearData.age;
          if(age >= params.ssStart) ssAnnual *= (1 + params.ssCola);
          if(age >= params.penStart && params.penMonthly > 0) penAnnual *= (1 + params.penCola);
          
          if(params.hasSpouse) {
            const spouseCurrentAge = params.spouseAge + (age - params.currentAge);
            if(spouseCurrentAge >= params.spouseSsStart) spouseSsAnnual *= (1 + params.spouseSsCola);
            if(spouseCurrentAge >= params.spousePenStart && params.spousePenMonthly > 0) spousePenAnnual *= (1 + params.spousePenCola);
          }
          
          spend *= (1 + params.inflation);
          spend *= (1 - params.spendingDecline);
        }

      
        console.log('Calculations: ', calculations);

      /**
       * Generate final summary, write table, and update KPIs
       */
      function generateOutputAndSummary(params, rows, totalTaxes, maxDrawdown) {
        // Write table
        const tbody = $('rows');
        tbody.innerHTML = calculations.map(r => `
          <tr>
            <td class="neutral">${r.year}</td>
            <td class="neutral">${r.age}</td>
            <td class="neutral">${r.spend ? fmt(r.spend) : ''}</td>
            <td class="income">${r.salary? fmt(r.salary): ''}</td>
            <td class="income">${r.contrib? fmt(r.contrib): ''}</td>
            <td class="income">${r.ss? fmt(r.ss): ''}</td>
            <td class="income">${r.pen? fmt(r.pen): ''}</td>
            <td class="income">${r.spouseSs? fmt(r.spouseSs): ''}</td>
            <td class="income">${r.spousePen? fmt(r.spousePen): ''}</td>
            <td class="income">${r.wNet ? fmt(r.wNet) : ''}</td>
            <td class="outgoing">${r.w401kGross? fmt(r.w401kGross): ''}</td>
            <td class="outgoing">${r.wSavingsGross? fmt(r.wSavingsGross): ''}</td>
            <td class="outgoing">${r.wRothGross? fmt(r.wRothGross): ''}</td>
            <td class="outgoing">${r.taxes? fmt(r.taxes): ''}</td>
            <td class="outgoing">${r.ssTaxes? fmt(r.ssTaxes): ''}</td>
            <td class="outgoing">${r.otherTaxes? fmt(r.otherTaxes): ''}</td>
            <td class="income">${r.nonTaxableIncome? fmt(r.nonTaxableIncome): ''}</td>
            <td class="neutral">${r.taxableIncome? fmt(r.taxableIncome): ''}</td>
            <td class="income">${r.taxableInterest? fmt(r.taxableInterest): ''}</td>
            <td class="neutral">${r.effectiveTaxRate ? r.effectiveTaxRate.toFixed(1) + '%' : ''}</td>
            <td class="neutral">${fmt(r.balSavings)}</td>
            <td class="neutral">${fmt(r.balPre)}</td>
            <td class="neutral">${fmt(r.balRoth)}</td>
            <td class="neutral">${fmt(r.total)}</td>
          </tr>`).join('');

        // KPIs
        const last = calculations[calculations.length - 1];
        // Find the last age where there's still money, or endAge if money lasts throughout
        const fundedTo = last.total > 0 ? params.endAge : calculations.reduce((lastGoodAge, r) => r.total > 0 ? r.age : lastGoodAge, params.currentAge);
        $('kpiAge').innerHTML = `${fundedTo} <span class="pill ${fundedTo >= params.endAge ? 'ok':'alert'}">${fundedTo >= params.endAge ? 'Fully funded' : 'Shortfall'}</span>`;
        $('kpiEndBal').textContent = fmt(Math.max(0, last.total));
        $('kpiDraw').textContent = `${params.retireAge}`;
        $('kpiTax').textContent = fmt(params.balPre + params.balRoth + params.balSavings);

        // Chart (total balance)
        drawChart(calculations.map(r => ({ x: r.year, y: r.total })));

        // Save rows for export
        window.__rows = rows;
      }

      // Key Performance Indicators
      const last = calculations[calculations.length - 1];
      // Find the last age where there's still money, or endAge if money lasts throughout
      const fundedTo = last.total > 0 ? endAge : calculations.reduce((lastGoodAge, r) => r.total > 0 ? r.age : lastGoodAge, currentAge);
      $('kpiAge').innerHTML = `${fundedTo} <span class="pill ${fundedTo >= endAge ? 'ok':'alert'}">${fundedTo >= endAge ? 'Fully funded' : 'Shortfall'}</span>`;
      $('kpiEndBal').textContent = fmt(Math.max(0, last.total));
      $('kpiDraw').textContent = `${retireAge}`;
      $('kpiTax').textContent = fmt(num('balPre') + num('balRoth') + num('balSavings'));

      // Chart (total balance)
      drawChart(calculations.map(r => ({ x: r.year, y: r.total })));

      // Save rows for export
      window.__rows = rows;
      
      // Generate final output
      generateOutputAndSummary(params, rows, totalTaxes, maxDrawdown);
    }

    function drawChart(series){
      const c = $('chart');
      const ctx = c.getContext('2d');
      
      // Ensure canvas has proper dimensions before drawing
      const dpr = window.devicePixelRatio || 1;
      const rect = c.getBoundingClientRect();
      const width = rect.width * dpr;
      const height = rect.height * dpr;
      
      // Force canvas to correct size if needed
      if(c.width !== width || c.height !== height) {
        c.width = width;
        c.height = height;
        c.style.width = rect.width + 'px';
        c.style.height = rect.height + 'px';
      }
      
      ctx.clearRect(0, 0, width, height);
      if(!series || !series.length){ return; }

      // Padding (in device pixels) - increased left padding for Y-axis labels
      const pad = { l: 80 * dpr, r: 12 * dpr, t: 12 * dpr, b: 28 * dpr };
      const xs = series.map(p=>p.x);
      const ys = series.map(p=>p.y);
      const xmin = Math.min(...xs), xmax = Math.max(...xs);
      const ymin = 0, ymax = Math.max(...ys) * 1.1;
      const xTo = x => pad.l + ( (x - xmin) / (xmax - xmin) ) * (width - pad.l - pad.r);
      const yTo = y => height - pad.b - ( (y - ymin) / (ymax - ymin) ) * (height - pad.t - pad.b);

      // Axes
      ctx.strokeStyle = '#22304d'; ctx.lineWidth = 1 * dpr; ctx.beginPath();
      ctx.moveTo(pad.l, yTo(0)); ctx.lineTo(width - pad.r, yTo(0));
      ctx.moveTo(pad.l, pad.t); ctx.lineTo(pad.l, height - pad.b); ctx.stroke();

      // Y ticks
      ctx.fillStyle = '#7c8db5'; ctx.font = `${12 * dpr}px system-ui`;
      ctx.textAlign = 'right';
      const steps = 4;
      for(let i=0;i<=steps;i++){
        const v = (ymax/steps)*i; const y = yTo(v);
        ctx.strokeStyle = 'rgba(34,48,77,.4)'; ctx.beginPath(); ctx.moveTo(pad.l, y); ctx.lineTo(width - pad.r, y); ctx.stroke();
        ctx.fillText(fmt(v), pad.l - 8 * dpr, y + 4 * dpr);
      }

      // Line
      ctx.strokeStyle = '#6ea8fe'; ctx.lineWidth = 2 * dpr; ctx.beginPath();
      series.forEach((p,i)=>{ const X = xTo(p.x), Y = yTo(p.y); if(i===0) ctx.moveTo(X,Y); else ctx.lineTo(X,Y); });
      ctx.stroke();

      // Points
      ctx.fillStyle = '#6ea8fe';
      series.forEach(p=>{ const X=xTo(p.x), Y=yTo(p.y); ctx.beginPath(); ctx.arc(X,Y,2.5 * dpr,0,Math.PI*2); ctx.fill(); });

      // X labels
      ctx.fillStyle = '#7c8db5'; ctx.textAlign='center'; ctx.font = `${11 * dpr}px system-ui`;
      const years = [series[0].x, series[Math.floor(series.length/2)].x, series[series.length-1].x];
      years.forEach(x => ctx.fillText(String(x), xTo(x), height - 6 * dpr));
    }

    function exportCSV(){
      const rows = window.__rows || [];
      if(!calculations.length){ 
        showToast('No Data', 'Run a calculation first to generate data for export.', 'warning');
        return; 
      }
      const headers = ['Year','Age','Salary','Contrib','SS_Net','Pension_Net','Spouse_SS_Net','Spouse_Pension_Net','Spend','Withdraw_Net','401k_Gross','Savings_Gross','Roth_Gross','Total_Taxes','SS_Taxes','Other_Taxes','Non_Taxable_Income','Taxable_Income','Taxable_Interest','Taxable_Bal','Pretax_Bal','Roth_Bal','Total_Bal'];
      const csv = [headers.join(',')]
        .concat(calculations.map(r=>[
          r.year, r.age, r.salary, r.contrib, r.ss, r.pen, r.spouseSs||0, r.spousePen||0, r.spend, r.wNet, r.w401kGross||0, r.wSavingsGross||0, r.wRothGross||0, r.taxes, r.ssTaxes||0, r.otherTaxes||0, r.nonTaxableIncome||0, r.taxableIncome||0, r.taxableInterest||0, r.balSavings, r.balPre, r.balRoth, r.total
        ].map(v => typeof v === 'number' ? Math.round(v*100)/100 : v).join(',')))
        .join('\n');
      const blob = new Blob([csv], {type:'text/csv'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'retirement_results.csv';
      document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    }

    function exportJSON(){
      const inputs = {};
      // Collect all input values including spending overrides
      document.querySelectorAll('input, select').forEach(input => {
        if(input.id && input.id !== 'jsonFileInput') {
          inputs[input.id] = input.value;
        }
      });
      
      const exportData = {
        version: '1.1',
        exportDate: new Date().toISOString(),
        description: 'Retirement Calculator Scenario with Spending Overrides',
        inputs: inputs
      };
      
      const json = JSON.stringify(exportData, null, 2);
      const blob = new Blob([json], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; 
      a.download = `retirement_scenario_${new Date().toISOString().split('T')[0]}.json`;
      document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    }

    function importJSON(){
      const fileInput = $('jsonFileInput');
      fileInput.click();
    }

    function handleJSONFile(event){
      const file = event.target.files[0];
      if (!file) return;
      
      if (!file.name.toLowerCase().endsWith('.json')) {
        showToast('Invalid File', 'Please select a JSON file.', 'error');
        return;
      }
      
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const data = JSON.parse(e.target.result);
          
          // Validate the JSON structure
          if (!data.inputs || typeof data.inputs !== 'object') {
            showToast('Invalid Format', 'Invalid JSON file format. Expected retirement calculator scenario data.', 'error');
            return;
          }
          
          let loadedCount = 0;
          let totalCount = 0;
          
          // Load all input values
          Object.entries(data.inputs).forEach(([id, value]) => {
            totalCount++;
            const element = document.getElementById(id);
            if(element) {
              element.value = value;
              loadedCount++;
            } else if (id.startsWith('spending_')) {
              // Handle spending override fields that may not exist yet
              totalCount--; // Don't count these in the totals since they're dynamic
            }
          });
          
          // If there are spending override fields in the import, regenerate the fields first
          const hasSpendingOverrides = Object.keys(data.inputs).some(id => id.startsWith('spending_'));
          if (hasSpendingOverrides) {
            regenerateSpendingFields();
            // Now load the spending override values
            Object.entries(data.inputs).forEach(([id, value]) => {
              if (id.startsWith('spending_')) {
                const element = document.getElementById(id);
                if (element) {
                  element.value = value;
                  loadedCount++;
                }
              }
            });
          }
          
          // Show import summary
          let summary = `Loaded ${loadedCount} of ${totalCount} settings.`;
          if (data.description) {
            summary += `\nDescription: ${data.description}`;
          }
          if (data.exportDate) {
            summary += `\nExported: ${new Date(data.exportDate).toLocaleDateString()}`;
          }
          
          showToast('Import Successful', summary, 'success', 7000);
          calc(); // Automatically recalculate
          
        } catch (error) {
          showToast('Import Error', 'Error reading JSON file: ' + error.message, 'error');
        }
      };
      
      reader.readAsText(file);
      // Clear the file input so the same file can be selected again
      event.target.value = '';
    }

    // Events
    $('calcBtn').addEventListener('click', calc);
    $('csvBtn').addEventListener('click', exportCSV);
    $('exportJsonBtn').addEventListener('click', exportJSON);
    $('importJsonBtn').addEventListener('click', importJSON);
    $('jsonFileInput').addEventListener('change', handleJSONFile);
    $('clearBtn').addEventListener('click', resetAll);
    $('useCurrentYearValues').addEventListener('change', function() {
      updateSpendingFieldsDisplayMode();
    });

    // Initialize help icons
    function initializeHelpIcons() {
      // Find all help icon placeholders and replace them with actual help icons
      const placeholders = document.querySelectorAll('.help-icon-placeholder');
      placeholders.forEach(placeholder => {
        const fieldId = placeholder.getAttribute('data-field');
        if (fieldId) {
          placeholder.innerHTML = createHelpIcon(fieldId);
        }
      });
      
      // Auto-convert remaining verbose SVG help icons to placeholders (one-time conversion)
      const existingSvgIcons = document.querySelectorAll('svg.help-icon[onclick*="showHelpToast"]');
      existingSvgIcons.forEach(svg => {
        const onclickAttr = svg.getAttribute('onclick');
        const match = onclickAttr.match(/showHelpToast\(event,\s*['"]([^'"]+)['"]\)/);
        if (match) {
          const fieldId = match[1];
          const placeholder = document.createElement('span');
          placeholder.className = 'help-icon-placeholder';
          placeholder.setAttribute('data-field', fieldId);
          placeholder.innerHTML = createHelpIcon(fieldId);
          svg.parentNode.replaceChild(placeholder, svg);
        }
      });
    }

    // First render
    initializeHelpIcons();
    loadExample();
    calc();
  </script>
</body>
</html>
