<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Oneâ€‘Page Retirement Calculator</title>
  <!-- jsPDF library for PDF generation -->
  <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script> -->
  <style>
    /*
    Scroll strategy:
    - Page never scrolls
    - Inputs scroll inside inputs-scroll
    - Results scroll inside .results
    - Tables may scroll internally
    */
    :root {
      --bg: #0b1220;
      --card: #121a2b;
      --muted: #7c8db5;
      --text: #e6eefc;
      --accent: #6ea8fe;
      --good: #45d483;
      --bad: #ff6b6b;
      --warn: #ffbf69;
      --border: #22304d;
      --inputs-width: 360px;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, "Helvetica Neue", Arial, "Apple Color Emoji", "Segoe UI Emoji";
      margin: 0;
      color: var(--text);
      background: radial-gradient(1200px 900px at 15% -10%, #1a2440, #0b1220 50%);
      height: 100vh;
      overflow: hidden;
      display: grid;
      grid-template-rows: auto 1fr;  /* header | main */
    }
    header {
      padding: 20px clamp(16px, 3vw, 40px);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      position: sticky; top: 0; backdrop-filter: blur(6px);
      background: linear-gradient(180deg, rgba(11,18,32,.85), rgba(11,18,32,.55));
      border-bottom: 1px solid var(--border);
      z-index: 10;
    }
    .title { font-weight: 700; letter-spacing:.2px; }
    .title small{ color: var(--muted); font-weight: 500; }

    .wrap {
      min-height: 0;          /* ðŸ”‘ allow children to shrink */
      overflow: hidden;

      display: grid;
      grid-template-columns: var(--inputs-width) 6px 1fr;
        }

    .wrap.inputs-hidden .card:first-of-type {
      display: none;
    }

    .wrap.is-dragging {
      transition: none;
    }
    
    /* @media (max-width: 980px){ .wrap{ grid-template-columns: 1fr; } } */

    .card {
      background: linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.00));
      border: 1px solid var(--border);
      border-radius: 16px;
      box-shadow: 0 10px 30px rgba(0,0,0,.2);
      container-type: inline-size;
    }

    details { border: 1px solid var(--border); border-radius: 12px; overflow: hidden; }
    details[open] summary { background: #0d172b; }
    summary { padding: 14px 14px; cursor: pointer; list-style: none; user-select: none; display:flex; align-items:center; justify-content:space-between; gap:8px; }
    summary::-webkit-details-marker{ display:none; }
    .chev { transition: transform .4s; }
    details[open] .chev{ transform: rotate(180deg); }
    .content { padding: 14px; border-top: 1px dashed var(--border); background: rgba(255,255,255,.02); display:grid; gap:10px; }

    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .grid-1 { display: grid; grid-template-columns: repeat(1, 1fr); gap: 10px; }
    .grid-2 { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
    .grid-3 {   
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 10px;
      }
    .grid-321 {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 10px;
    }
    @container (max-width: 550px){ .grid-3 { grid-template-columns: 1fr; } }

    label { display: block; font-size: 12px; color: var(--muted); margin-bottom: 4px; }
    input, select { width: 100%; padding: 10px 11px; background: #0b1426; color: var(--text); border: 1px solid var(--border); border-radius: 10px; outline: none; }
    input:focus, select:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(110,168,254,.15); }
    
    /* Override default input styling for checkbox */
    #hideInputsCheckbox {
      width: auto !important;
      padding: 0 !important;
      background: transparent !important;
      border: none !important;
      border-radius: 0 !important;
    }
    .hint { font-size: 12px; color: var(--muted); }

    @media (max-width: 640px) {
      .inputs-actions {
        flex-direction: column;
      }
    }

    button {
      appearance: none; border: 1px solid var(--border); background: #0f1930; color: var(--text);
      padding: 10px 14px; border-radius: 10px; font-weight: 600; cursor: pointer; transition: .2s;
    }
    .primary { background: linear-gradient(180deg, #2b63ff, hsl(227, 71%, 48%)); border-color: #1f3fb8; }
    #pdfBtn { background: linear-gradient(180deg, #d63384, #b02a5b); border-color: #9a2456; color: white; }
    button:hover { transform: translateY(-1px); filter: brightness(1.07); }

    .results { 
      padding: 18px; 
      display: grid; 
      gap: 12px; 
      max-height: 100vh;
      overflow-y: auto;
    }
    .summary { display: grid; grid-template-columns: repeat(4, minmax(0,1fr)); gap: 10px; }
    @media (max-width: 900px){ .summary{ grid-template-columns: repeat(2, minmax(0,1fr)); } }
    .kpi { background: #0b1426; border: 1px solid var(--border); border-radius: 12px; padding: 12px; }
    .kpi .label { color: var(--muted); font-size: 12px; }
    .kpi .value { font-size: 20px; font-weight: 700; margin-top: 2px; }

    canvas { width: 100%; height: 260px; background: #0b1426; border: 1px solid var(--border); border-radius: 12px; position: relative; }

    /* Chart tooltip styles */
    .chart-tooltip {
      position: absolute;
      background: rgba(13, 23, 43, 0.95);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 8px 12px;
      font-size: 12px;
      color: var(--text);
      pointer-events: none;
      z-index: 1000;
      opacity: 0;
      transition: opacity 0.2s ease;
      backdrop-filter: blur(8px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }
    .chart-tooltip.visible {
      opacity: 1;
    }
    .chart-tooltip .year {
      font-weight: 600;
      color: #6ea8fe;
      margin-bottom: 2px;
    }
    .chart-tooltip .balance {
      color: var(--text);
    }

    table { width: 100%; border-collapse: collapse; font-size: 13px; }
    th, td { border-bottom: 1px solid var(--border); padding: 8px; text-align: right; white-space: nowrap; }
    th:first-child, td:first-child, th:nth-child(2), td:nth-child(2) { text-align: left; }
    thead th { position: sticky; top: 0; background: #0d172b; z-index: 1; }
    tbody tr:hover { background: rgba(255,255,255,.03); }

    /* Frozen columns: Year and Age ONLY - Solid background approach */
    
    /* First row headers (section headers) - Year and Age have rowspan=2 */
    thead tr.section-headers th:nth-child(1), /* Year */
    thead tr.section-headers th:nth-child(2)  /* Age */ {
      position: sticky;
      top: 0;
      z-index: 4;
      background: #0d172b;
      border-right: 2px solid var(--border);
    }
    thead tr.section-headers th:nth-child(1) { 
      left: 0; 
      min-width: 70px;
    }
    thead tr.section-headers th:nth-child(2) { 
      left: 70px; 
      min-width: 60px;
    }
    
    /* Add solid background extensions using pseudo-elements */
    thead tr.section-headers th:nth-child(1):after {
      content: '';
      position: absolute;
      top: 0;
      bottom: 0;
      left: 100%;
      width: 2px;
      background: #0d172b;
      z-index: 1;
    }
    thead tr.section-headers th:nth-child(2):after {
      content: '';
      position: absolute;
      top: 0;
      bottom: 0;
      left: 100%;
      width: 2px;
      background: #0d172b;
      z-index: 1;
    }
    
    /* Second row headers (column headers) - sticky top only */
    thead tr.column-headers th {
      position: sticky;
      z-index: 3;
      background: #051d08;
    }
    
    /* Body cells - only first two columns (Year and Age) */
    tbody td:nth-child(1) { /* Year */
      position: sticky;
      left: 0;
      background: #0d172b;
      z-index: 2;
      border-right: 2px solid var(--border);
      min-width: 70px;
    }
    tbody td:nth-child(2) { /* Age */
      position: sticky;
      left: 70px;
      background: #0d172b;
      z-index: 2;
      border-right: 2px solid var(--border);
      min-width: 60px;
    }
    
    /* Add solid background extensions for body cells */
    tbody td:nth-child(1):after {
      content: '';
      position: absolute;
      top: 0;
      bottom: 0;
      left: 100%;
      width: 2px;
      background: #0d172b;
      z-index: 1;
    }
    tbody td:nth-child(2):after {
      content: '';
      position: absolute;
      top: 0;
      bottom: 0;
      left: 100%;
      width: 2px;
      background: #0d172b;
      z-index: 1;
    }
    
    /* Ensure hover state doesn't interfere with frozen columns */
    tbody tr:hover td:nth-child(1), 
    tbody tr:hover td:nth-child(2) {
      background: #0d172b !important;
    }
    tbody tr:hover td:nth-child(1):after,
    tbody tr:hover td:nth-child(2):after {
      background: #0d172b !important;
    }
    
    /* Ensure all other columns scroll normally */
    tbody td:nth-child(n+3) {
      position: relative;
      left: auto;
      z-index: auto;
    }

    /* Section header styling */
    .section-headers th {
      background: linear-gradient(135deg, #4a5568 0%, #2d3748 100%);
      color: white;
      font-weight: 600;
      padding: 12px 8px;
      text-align: center;
      border: 1px solid #2d3748;
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      top: 0;
      z-index: 2;
    }
    
    /* Individual column header styling */
    .column-headers th {
      background: #1a2332;
      color: #e6eefc;
      font-weight: 500;
      padding: 8px 6px;
      text-align: center;
      border: 1px solid var(--border);
      font-size: 11px;
      top: 41px;
      z-index: 1;
    }
    
    /* Section-specific colors for main headers */
    .timeline-header { background: linear-gradient(135deg, #2b6cb0 0%, #1e4a8c 100%) !important; }
    .need-header { background: linear-gradient(135deg, #c53030 0%, #9b2c2c 100%) !important; }
    .income-header { background: linear-gradient(135deg, #38a169 0%, #2f855a 100%) !important; }
    .gross-income-header { background: linear-gradient(135deg, #f56500 0%, #dd6b20 100%) !important; }
    .withdrawal-header { background: linear-gradient(135deg, #d69e2e 0%, #b7791f 100%) !important; }
    .breakdown-header { background: linear-gradient(135deg, #805ad5 0%, #6b46c1 100%) !important; }
    .tax-header { background: linear-gradient(135deg, #e53e3e 0%, #c53030 100%) !important; }
    .balance-header { background: linear-gradient(135deg, #3182ce 0%, #2c5aa0 100%) !important; }

    /* Color coding for table values */
    .income { color: #4ade80; } /* Green for income */
    .outgoing { color: #f87171; } /* Red for outgoing */
    .neutral { color: var(--text); } /* Default color for neutral items */

    .pill { padding:.2rem .5rem; border-radius: 999px; font-size: 12px; font-weight:600; display:inline-block; }
    .ok { color: #0b5; background: rgba(69,212,131,.15); border: 1px solid rgba(69,212,131,.3); }
    .alert { color: #ff6b6b; background: rgba(255,107,107,.15); border:1px solid rgba(255,107,107,.3); }
    .warn { color: #ffbf69; background: rgba(255,191,105,.15); border:1px solid rgba(255,191,105,.3); }
    .disclaimer { color: var(--muted); font-size: 12px; }
    
    /* SS Breakdown Popup Styles */
    .ss-popup {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      z-index: 100000;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    
    .ss-popup.show {
      display: flex;
    }
    
    .ss-popup-content {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 24px;
      max-width: 500px;
      width: 100%;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 20px 50px rgba(0, 0, 0, 0.4);
    }

    .ss-popup-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    
    .ss-popup-title {
      font-size: 18px;
      font-weight: 600;
      color: var(--text);
      margin: 0;
    }
    
    .ss-popup-close {
      background: none;
      border: none;
      color: var(--muted);
      font-size: 24px;
      cursor: pointer;
      padding: 0;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
    }
    
    .ss-popup-close:hover {
      background: rgba(255, 255, 255, 0.1);
      color: var(--text);
    }
    
    .export-btn {
      background: var(--accent);
      border: none;
      color: white;
      font-size: 12px;
      cursor: pointer;
      padding: 6px 12px;
      border-radius: 4px;
      margin-right: 8px;
      font-weight: 500;
      transition: all 0.2s ease;
    }
    
    .export-btn:hover {
      background: var(--accent-hover);
      transform: translateY(-1px);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }
    
    .export-btn:active {
      transform: translateY(0);
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
    }

    .ss-breakdown-item {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid var(--border);
    }
    
    .ss-breakdown-item:last-child {
      border-bottom: none;
      font-weight: 600;
      padding-top: 12px;
      margin-top: 8px;
      border-top: 2px solid var(--border);
    }
    
    .ss-breakdown-label {
      color: var(--muted);
    }
    
    .ss-breakdown-value {
      color: var(--text);
      font-weight: 500;
    }

    /* Total row styling for breakdown tables */
    .total-row td {
      border-top: 3px double var(--border);
      padding-top: 12px;
      font-weight: 600;
    }

    /* Popup table header styling to obscure scrolling content */
    .ss-popup-content table thead th {
      position: sticky;
      top: -24px;
      background: var(--card);
      z-index: 10;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }
    
    /* Ensure popup table headers have solid background */
    .ss-popup-content .breakdown-table thead th {
      background: var(--card);
      backdrop-filter: blur(8px);
      border-bottom: 2px solid var(--border);
    }
    
    .ss-breakdown-item:last-child .ss-breakdown-label,
    .ss-breakdown-item:last-child .ss-breakdown-value {
      color: var(--accent);
    }
    
    /* Clickable SS link styling */
    .ss-link {
      color: inherit;
      text-decoration: underline;
      cursor: pointer;
      text-decoration-style: dotted;
    }
    
    .ss-link:hover {
      color: var(--accent);
      text-decoration-style: solid;
    }
    
    /* Clickable Taxable Income link styling */
    .taxable-income-link {
      color: inherit;
      text-decoration: underline;
      cursor: pointer;
      text-decoration-style: dotted;
    }
    
    .taxable-income-link:hover {
      color: var(--accent);
      text-decoration-style: solid;
    }
    
    /* Clickable Withdrawal Net link styling */
    .withdrawal-net-link {
      color: inherit;
      text-decoration: underline;
      cursor: pointer;
      text-decoration-style: dotted;
    }
    
    .withdrawal-net-link:hover {
      color: var(--accent);
      text-decoration-style: solid;
    }
    
    /* Clickable Non-taxable Income link styling */
    .non-taxable-income-link {
      color: inherit;
      text-decoration: underline;
      cursor: pointer;
      text-decoration-style: dotted;
    }
    
    .non-taxable-income-link:hover {
      color: var(--accent);
      text-decoration-style: solid;
    }
    
    /* Clickable Provisional Income link styling */
    .provisional-income-link {
      color: inherit;
      text-decoration: underline;
      cursor: pointer;
      text-decoration-style: dotted;
    }
    
    .provisional-income-link:hover {
      color: var(--accent);
      text-decoration-style: solid;
    }
    
    /* Clickable Total Taxes link styling */
    .total-taxes-link {
      color: inherit;
      text-decoration: underline;
      cursor: pointer;
      text-decoration-style: dotted;
    }
    
    .total-taxes-link:hover {
      color: var(--accent);
      text-decoration-style: solid;
    }
    
    /* Clickable Savings Balance link styling */
    .savings-balance-link {
      color: inherit;
      text-decoration: underline;
      cursor: pointer;
      text-decoration-style: dotted;
    }
    
    .savings-balance-link:hover {
      color: var(--accent);
      text-decoration-style: solid;
    }

    /* Toast Notification Styles */
    .toast {
      position: fixed !important;
      top: 20px !important;
      right: 20px !important;
      background: #fffbf0 !important;
      border: 1px solid #f0ad4e !important;
      border-radius: 8px !important;
      padding: 16px !important;
      max-width: 300px !important;
      box-shadow: 0 4px 12px rgba(240, 173, 78, 0.3) !important;
      z-index: 99999 !important;
      opacity: 0 !important;
      transform: translateY(-10px) !important;
      transition: opacity 0.3s ease, transform 0.3s ease !important;
      overflow: visible !important;
      pointer-events: auto !important;
      display: block !important;
      visibility: visible !important;
      width: auto !important;
      height: auto !important;
    }
    .toast.show {
      opacity: 1 !important;
      transform: translateY(0) !important;
      visibility: visible !important;
    }
    .toast .toast-title {
      font-weight: 600;
      color: #8a6914;
      margin-bottom: 8px;
      font-size: 14px;
    }
    .toast .toast-body {
      color: #856404;
      font-size: 13px;
      line-height: 1.4;
    }
    .toast .progress-bar {
      position: absolute;
      bottom: 0;
      left: 0;
      height: 3px;
      background: #f0ad4e;
      transition: width linear;
      border-radius: 0 0 8px 8px;
      width: 0%;
    }
    
    /* Toast Type Variations */
    .toast-success {
      background: #f0fff4 !important;
      border-color: #28a745 !important;
      box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3) !important;
    }
    .toast-success .toast-title {
      color: #155724;
    }
    .toast-success .toast-body {
      color: #155724;
    }
    .toast-success .progress-bar {
      background: #28a745;
    }
    
    .toast-error {
      background: #fff5f5 !important;
      border-color: #dc3545 !important;
      box-shadow: 0 4px 12px rgba(220, 53, 69, 0.3) !important;
    }
    .toast-error .toast-title {
      color: #721c24;
    }
    .toast-error .toast-body {
      color: #721c24;
    }
    .toast-error .progress-bar {
      background: #dc3545;
    }
    
    .toast-warning {
      background: #fffbf0 !important;
      border-color: #ffc107 !important;
      box-shadow: 0 4px 12px rgba(255, 193, 7, 0.3) !important;
    }
    .toast-warning .toast-title {
      color: #856404;
    }
    .toast-warning .toast-body {
      color: #856404;
    }
    .toast-warning .progress-bar {
      background: #ffc107;
    }
    
    .toast-info {
      background: #f0f8ff !important;
      border-color: #17a2b8 !important;
      box-shadow: 0 4px 12px rgba(23, 162, 184, 0.3) !important;
    }
    .toast-info .toast-title {
      color: #0c5460;
    }
    .toast-info .toast-body {
      color: #0c5460;
    }
    .toast-info .progress-bar {
      background: #17a2b8;
    }
    
 /* Help icon â€” matches legacy inline SVG exactly */
.help-icon {
  display: inline-block;
  width: 1em;
  height: 1em;

  /* Match old muted gray */
  color: var(--muted);

    /* Force SVG to respect currentColor */
  fill: currentColor;
  stroke: currentColor;

  /* Match old perceived size */
  transform: scale(0.78);
  transform-origin: center;

  margin-left: 0.3em;
  vertical-align: middle;

  cursor: pointer;
}

.help-icon:hover {
  opacity: 1.0;
  color: #FFFFFF;
}

    #splitter {
      cursor: col-resize;
      background: linear-gradient(
        180deg,
        rgba(255,255,255,0.05),
        rgba(255,255,255,0.02)
      );
      border-left: 1px solid var(--border);
      border-right: 1px solid var(--border);
      height: 100%;
      min-height: 0;
      position: relative;
    }

    /* Optional grip dots */
    #splitter::before {
      content: 'â‹®â‹®';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: var(--muted);
      font-size: 14px;
      opacity: 0.6;
    }

    #splitter::after {
      content: '';
      position: absolute;
      inset: 0;
      background: rgba(110,168,254,0.35);
      opacity: 0;
      transition: opacity 120ms ease;
    }

    #splitter:hover {
      background: rgba(110,168,254,0.15);
    }

    #splitter:hover::after {
      opacity: 1;
    }

    .wrap.inputs-hidden {
      grid-template-columns: 1fr;
    }

    .wrap.inputs-hidden #splitter {
      display: none;
    }

    .wrap.inputs-hidden .card:first-of-type {
      display: none;
    }

    /* ---------- Animated details ---------- */

 details {
  overflow: hidden;
}

details .content {
  overflow: hidden;
  height: 0;
  opacity: 0;
}

details[open] .content {
  opacity: 1;
}

.chev {
  transition: transform 650ms ease;
}


    details:not([open]) {
      opacity: 0.92;
    }

    details:focus-within {
      border-color: var(--accent);
    }

.inputs-panel {
  display: grid;
  grid-template-rows: auto minmax(0, 1fr) auto;
  min-height: 0;
  overflow: hidden;
}

/* Header */
.inputs-header {
  padding: 18px 18px 8px;
  flex-shrink: 0;
}

.inputs-header h3 {
  margin: 0;
  font-size: 14px;
  color: var(--muted);
  font-weight: 600;
  letter-spacing: 0.4px;
  text-transform: uppercase;
}

/* Scrollable content */
.inputs-scroll {
  min-height: 0;
  overflow-y: auto;
  padding: 0 18px 18px;
  display: grid;
  gap: 12px;
}

/* Actions footer */
.inputs-actions {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  padding: 14px;
  border-top: 1px solid var(--border);
  background: #0c1323;
  justify-content: flex-end;
}

.inputs-actions button {
  flex: 1 1 160px;
}

/* Wrapper behaves like inline text */
.label-with-help {
  display: inline;
}

/* Label keeps existing typography */
.label-with-help > label {
  display: inline;
}


  </style>
</head>
<body>
  <header>
    <div class="title">
      <div style="font-size:20px">Retirement Calculator</div>
      <small>Preâ€‘tax vs Roth vs Taxable â€¢ Social Security â€¢ Pension â€¢ Spouse benefits â€¢ Declining spending â€¢ Employer match</small>
      <label style="display: flex; align-items: center; gap: 6px; cursor: pointer; color: var(--text); font-size: 14px;">
        <input type="checkbox" id="hideInputsCheckbox" style="cursor: pointer;">
        Hide Inputs
      </label>   </div>
    <div>
      <input type="file" id="jsonFileInput" accept=".json" style="display: none;">
      <button id="clearBtn">Reset</button>
      <button id="calcBtn" class="primary" title="Calculate (Ctrl+Enter)">Calculate â–¶</button>
 
    </div>
  </header>

  <!-- SVG symbol definitions (define once) -->
    <svg xmlns="http://www.w3.org/2000/svg" 
      viewBox="0 0 24 24" 
      width="1em" 
      height="1em" 
      fill="white" 
      class="help-icon"
      onclick="showHelpToast(event, 'totalSavingsBalance')" 
      style="vertical-align: middle;">
      <circle cx="12" cy="12" r="10" stroke="white" stroke-width="2" fill="none" />
      <path d="M9.5 9a2.5 2.5 0 0 1 5 0c0 1.5-2.5 2-2.5 3.5v1" stroke="white" stroke-width="2" fill="none"
        stroke-linecap="round" />
      <circle cx="12" cy="17" r="1" fill="white" />
    </svg>
  <svg xmlns="http://www.w3.org/2000/svg" 
    style="display: none;">
    <symbol id="icon-help" viewBox="0 0 24 24">
      <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" fill="none" />
      <path d="M9.5 9a2.5 2.5 0 0 1 5 0
           c0 1.5-2.5 2-2.5 3.5v1" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" />
      <circle cx="12" cy="17" r="1" fill="currentColor" />
    </symbol>
  </svg>

  <main class="wrap">
    <!-- Inputs -->
    <section class="card inputs-panel">
      <div class="inputs-header">
        <h3>Inputs</h3>
      </div>
      <div class="inputs-scroll" id="inputsSections">
        <div id="subjectSection"></div>
        <div id="spouseSection"></div>
        <div id="annualSpendingSection"></div>
        <div id="balancesSection"></div>
        <div id="workSection"></div>
        <div id="socialSecuritySection"></div>
        <div id="pensionSection"></div>
        <div id="taxesSection"></div>
        <div id="taxableIncomeAdjustmentsSection"></div>
        <div id="taxfreeIncomeAdjustmentsSection"></div>
      </div>
      <div class="inputs-actions">
        <button id="pdfBtn" title="Generate comprehensive PDF report">PDF Report</button>
        <button id="csvBtn" title="Export yearly table">Export CSV</button>
        <button id="exportJsonBtn" title="Export inputs as JSON file">Export JSON</button>
        <button id="importJsonBtn" title="Import inputs from JSON file">Import JSON</button>
        <input type="file" id="jsonFileInputFile" accept=".json" style="display: none;">
      </div>
    </section>

    <div id="splitter"></div>

    <!-- Results -->
    <section class="card">
      <div class="results">
        <div class="summary">
          <div class="kpi"><div class="label">Retirement Age</div><div id="kpiDraw" class="value">â€”</div></div>
          <div class="kpi"><div class="label">Funded to Age</div><div id="kpiAge" class="value">â€”</div></div>
          <div class="kpi"><div class="label">Starting Balance</div><div id="kpiTax" class="value">â€”</div></div>
          <div class="kpi"><div class="label">Ending Balance</div><div id="kpiEndBal" class="value">â€”</div></div>
        </div>
        <div style="position: relative;">
          <canvas id="chart" height="260"></canvas>
          <div id="chartTooltip" class="chart-tooltip">
            <div class="year"></div>
            <div class="balance"></div>
          </div>
        </div>
        <div class="card" style="padding:0; overflow:auto; max-height: 50vh;">
          <table>
            <thead>
              <!-- Main section headers -->
              <tr class="section-headers">
                <th rowspan="2" class="timeline-header">Year</th>
                <th rowspan="2" class="timeline-header">Age</th>
                <th rowspan="2" class="need-header">Annual Spend</th>
                <th colspan="7" class="income-header">Net Income</th>
                <th colspan="8" class="gross-income-header">Gross Income</th>
                <th colspan="3" class="breakdown-header">Income Breakdown</th>
                <th colspan="6" class="tax-header">Tax Information</th>
                <th colspan="4" class="balance-header">Account Balances</th>
              </tr>
              <!-- Sub-headers for individual columns -->
              <tr class="column-headers">
                <!-- Net Income (what you actually receive) -->
                <th>SS (Net)</th>
                <th>Pension (Net)</th>
                <th>Spouse SS (Net)</th>
                <th>Spouse Pen (Net)</th>
                <th>401k (Net)</th>
                <th>Savings/Roth</th>
                <th>Total Net</th>
                
                <!-- Gross Income (before taxes/deductions) -->
                <th>Salary</th>
                <th>Taxable Interest</th>
                <th>SS Gross</th>
                <th>Pension Gross</th>
                <th>Spouse SS Gross</th>
                <th>Spouse Pen Gross</th>
                <th>401k Gross</th>
                <th>Total Gross</th>
                
                <!-- Income Breakdown -->
                <th>Taxable Income</th>
                <th>Non-Taxable Income</th>
                <th>Provisional Income</th>
                
                <!-- Tax Information -->
                <th>Standard Deduction</th>
                <th>Taxable Income</th>
                <th>SS Taxes</th>
                <th>Other Taxes</th>
                <th>Total Taxes</th>
                <th>Effective Tax Rate</th>
                
                <!-- Account Balances -->
                <th>Savings Bal</th>
                <th>401k Bal</th>
                <th>Roth Bal</th>
                <th>Total Bal</th>
              </tr>
            </thead>
            <tbody id="rows"></tbody>
          </table>
        </div>
        <div class="disclaimer">This is an educational, simplified model. It ignores many realities (RMDs, detailed SS taxability, brackets/credits, healthcare, sequence risk, etc.). Consult a fiduciary advisor and a tax professional for personalized guidance.</div>
      </div>
    </section>
  </main>


  <script>
    window.layoutState = {
      currentLeftWidth: 360
    };
  </script>



<script type="module">
  import { showHelpToast, loadPartial, initUI, resyncAllOpenDetails, detailsObservers } from './retirement-ui.js';
  
  window.resyncAllOpenDetails = resyncAllOpenDetails;

  /**
   * OBSERVER INVARIANT
   * ------------------
   * - Container queries control column count
   * - `.inputs-scroll` is the container-query driver
   * - `.content` height must track changes caused by container width
   *
   * Therefore:
   * âŒ Do NOT observe `.content` only
   * âœ… ALWAYS observe `.inputs-scroll`
   */

  function persistDetailsState(root = document) {
      const STORAGE_PREFIX = 'details:';

      root.querySelectorAll('details[data-key]').forEach(details => {
        const key = STORAGE_PREFIX + details.dataset.key;

        // Restore state
        const saved = localStorage.getItem(key);
        if (saved === 'open') {
          details.open = true;
        } else if (saved === 'closed') {
          details.open = false;
        }

        // Listen for user toggle
        details.addEventListener('toggle', () => {
          localStorage.setItem(key, details.open ? 'open' : 'closed');
        });
      });
    } 

 function animateDetails(root = document) {
    root.querySelectorAll('details').forEach(details => {
      const summary = details.querySelector('summary');
      const content = details.querySelector('.content');
      if (!summary || !content) return;

      summary.addEventListener('click', e => {
        e.preventDefault();

        content.getAnimations().forEach(a => a.cancel());

        const isOpen = details.hasAttribute('open');

        if (isOpen) {
          // ----- CLOSE -----
          const ro = detailsObservers.get(details);
          if (ro) ro.disconnect();
          detailsObservers.delete(details);

          const startHeight = content.offsetHeight;

          content.animate(
            [
              { height: startHeight + 'px', opacity: 1 },
              { height: '0px', opacity: 0 }
            ],
            { duration: 220, easing: 'ease-in', fill: 'forwards' }
          ).onfinish = () => {
            details.removeAttribute('open');
            content.style.height = '';
          };

        } else {
          // ----- OPEN -----
          details.setAttribute('open', '');
          content.style.height = '0px';

          // Let container queries + grid settle
          requestAnimationFrame(() => {
            requestAnimationFrame(() => {
              const endHeight = content.scrollHeight;

              content.animate(
                [
                  { height: '0px', opacity: 0 },
                  { height: endHeight + 'px', opacity: 1 }
                ],
                { duration: 260, easing: 'ease-out', fill: 'forwards' }
              ).onfinish = () => {
                content.style.height = content.scrollHeight + 'px';
                detailsObservers.set(details, syncOpenDetailsHeight(details, content));
              };
            });
          });
        }
      });
    });
  }

  function syncOpenDetailsHeight(details, content) {
    const inputsScroll = details.closest('.inputs-scroll');
    if (!inputsScroll) {
      console.warn('No inputs-scroll found for details', details);
      return null;
    }
    let raf;

    const ro = new ResizeObserver(() => {
      if (!details.hasAttribute('open')) return;

      cancelAnimationFrame(raf);
      raf = requestAnimationFrame(() => {
        content.style.height = content.scrollHeight + 'px';
      });
    });

    // ðŸ”‘ Observe the container-query driver
    if (inputsScroll) {
      ro.observe(inputsScroll);
    }

    return ro;
  }

  function hydrateOpenDetails(root = document) {
      root.querySelectorAll('details[open]').forEach(details => {
        const content = details.querySelector('.content');
        if (!content) return;

        // Cancel any stale animations
        content.getAnimations().forEach(a => a.cancel());

        // Force correct height
        content.style.height = content.scrollHeight + 'px';
        content.style.opacity = '1';

        // Attach observer if missing
        if (!detailsObservers.has(details)) {
          const ro = syncOpenDetailsHeight(details, content);
          if (ro) detailsObservers.set(details, ro);
        }
      });
    }



  
  const partials = [
    ['#subjectSection', './partials/subject.html'],
    ['#socialSecuritySection', './partials/socialSecurity.html'],
    ['#pensionSection', './partials/pension.html'],
    ['#spouseSection', './partials/partner.html'],
    ['#annualSpendingSection', './partials/fiscal.html'],
    // ['#workSection', './partials/work.html'],
    ['#balancesSection', './partials/balances.html'],
    ['#taxesSection', './partials/withholdings.html'],
    ['#taxableIncomeAdjustmentsSection', './partials/taxableIncomeAdjustments.html'],
    ['#taxfreeIncomeAdjustmentsSection', './partials/taxfreeIncomeAdjustments.html']
  ];

  await Promise.all(
    partials.map(p => loadPartial(p[0], p[1]))
  );

  initUI();

   document.querySelectorAll("labeled-input").forEach((el) => {
      el.onHelp = (event, helpKey) => {
        showHelpToast(event, helpKey);
      };
    });
  
  persistDetailsState(document);

  // Ensure clean slate
  detailsObservers.forEach(ro => ro.disconnect());
  detailsObservers.clear();

  // Bind animations
  animateDetails(document);

  // ðŸ”‘ FINAL STEP: hydrate restored-open sections
  requestAnimationFrame(() => {
    hydrateOpenDetails(document);
  });
</script>

<script>
  // Handle inputs panel toggle
  document.addEventListener('DOMContentLoaded', function() {
    // debugger;
    const hideInputsCheckbox = document.getElementById('hideInputsCheckbox');
    const wrap = document.querySelector('.wrap');

    if (hideInputsCheckbox && wrap) {
      hideInputsCheckbox.addEventListener('change', function() {
        wrap.classList.toggle('inputs-hidden', hideInputsCheckbox.checked);
        requestAnimationFrame(() => {
          window.resyncAllOpenDetails?.(); 
        });
      });
    }
  });
</script>

<!-- Module Imports -->
<script type="module" src="components.js"></script>
<script type="module" src="debugUtils.js"></script>
<script type="module" src="consts.js"></script>
<script type="module" src="utils.js"></script>
<script type="module" src="cCommon.js"></script>
<script type="module" src="cEnum.js"></script>

<!-- Classes that only use primitive types -->
<script type="module" src="cBalances.js"></script>
<script type="module" src="cTaxes.js"></script>
<script type="module" src="cRetirementAccountBreakdown.js"></script>
<script type="module" src="cEmploymentInfo.js"></script>
<script type="module" src="cWorkingYearIncome.js"></script>
<script type="module" src="cEnum.js"></script>
<script type="module" src="cGaap.js"></script>
<script type="module" src="cGaapAnalyzer.js"></script>


<script type="module" src="cInputs.js"></script>
<script type="module" src="cDemographics.js"></script>
<script type="module" src="cFiscalData.js"></script>
<script type="module" src="cBenefits.js"></script>
<script type="module" src="cTransaction.js"></script>
<script type="module" src="cAccount.js"></script>
<script type="module" src="cAccountYear.js"></script>
<script type="module" src="cAccountsManager.js"></script>
<script type="module" src="cAccountingYear.js"></script>
<script type="module" src="cBalance.js"></script>
<script type="module" src="cTaxCalculations.js"></script>

<script type="module" src="cDeposits.js"></script>
<script type="module" src="cWithdrawals.js"></script>


<script type="module" src="cTargetedAccount.js"></script>

<script type="module" src="cSsBreakdown.js"></script>
<script type="module" src="cSsBenefitsCalculator.js"></script>
<script type="module" src="cSocialSecurityIncome.js"></script>
<script type="module" src="cExpenditures.js"></script>

<script type="module" src="cRetirementYearData.js"></script>
<script type="module" src="cAccountPortioner.js"></script>
<script type="module" src="cContributions.js"></script>


<script type="module" src="cWorkingYearData.js"></script>
<script type="module" src="cDebugData.js"></script>

<script type="module" src="cWorkingYearCalculator.js"></script>
<script type="module" src="cRetirementYearCalculator.js"></script>
<script type="module" src="retirement-calculator.js"></script>
<!-- <script type="module" src="retirement-ui.js"></script> -->
<script type="module" src="retirement-popups.js"></script>
<script>
  const STORAGE_KEY = 'inputsWidth';
  const DEFAULT_LEFT_WIDTH = 360;

  const wrap = document.querySelector('.wrap');
  const splitter = document.getElementById('splitter');

  document.addEventListener('DOMContentLoaded', () => {

    let isDragging = false;
    let startX = 0;
    let startLeftWidth = 0;

    function setInputsWidth(px) {
      window.layoutState.currentLeftWidth = px;
      document.documentElement.style.setProperty(
        '--inputs-width',
        `${px}px`
      );
      localStorage.setItem('inputsWidth', px);
    }

    window.layoutState.currentLeftWidth =
      Number(localStorage.getItem(STORAGE_KEY)) || DEFAULT_LEFT_WIDTH;

    setInputsWidth(window.layoutState.currentLeftWidth);
    document.documentElement.style.setProperty(
      '--inputs-width',
      `${window.layoutState.currentLeftWidth}px`
    );

    splitter.addEventListener('mousedown', (e) => {
      if (wrap.classList.contains('inputs-hidden')) return;
      wrap.classList.add('is-dragging');
      isDragging = true;

      const wrapRect = wrap.getBoundingClientRect();

      startLeftWidth = window.layoutState.currentLeftWidth;
      startX = e.clientX;

      document.body.style.cursor = 'col-resize';
      document.body.style.userSelect = 'none';
    });


    document.addEventListener('mousemove', (e) => {
      if (!isDragging) return;

      const delta = e.clientX - startX;
      const wrapRect = wrap.getBoundingClientRect();

      const min = 260;
      const max = wrapRect.width - 400;

      const newLeft = Math.min(
        Math.max(startLeftWidth + delta, min),
        max
      );

      // wrap.style.gridTemplateColumns = `${newLeft}px 6px 1fr`;
      window.layoutState.currentLeftWidth = newLeft;
      setInputsWidth(newLeft);
      
      requestAnimationFrame(() => {
        requestAnimationFrame(() => {
          window.resyncAllOpenDetails?.();
        });
      });
    });

    document.addEventListener('mouseup', () => {
      isDragging = false;
      wrap.classList.remove('is-dragging');
      document.body.style.cursor = '';
      document.body.style.userSelect = '';
    });

    splitter.addEventListener('dblclick', (e) => {
      e.preventDefault();

      setInputsWidth(DEFAULT_LEFT_WIDTH);
    });
  });

  document.addEventListener('keydown', (e) => {
      if (!e.altKey) return;
      if (!wrap) return;
      if (wrap.classList.contains('inputs-hidden')) return;

      const step = e.shiftKey ? 60 : 20;
      let width = window.layoutState.currentLeftWidth;

      if (e.key === 'ArrowLeft') {
        width -= step;
      } else if (e.key === 'ArrowRight') {
        width += step;
      } else {
        return;
      }

      e.preventDefault();

      const wrapRect = wrap.getBoundingClientRect();
      const min = 260;
      const max = wrapRect.width - 400;

      setInputsWidth(Math.min(Math.max(width, min), max));
      window.resyncAllOpenDetails?.();
    });

  window.addEventListener("resize", () => {
      window.resyncAllOpenDetails?.();
    });
</script>



  <!-- SS Breakdown Popup -->
  <div id="ssPopup" class="ss-popup">
    <div class="ss-popup-content">
      <div class="ss-popup-header">
        <h3 class="ss-popup-title">Social Security Breakdown</h3>
        <button class="ss-popup-close" onclick="closeSsPopup()">&times;</button>
      </div>
      <div id="ssBreakdownContent">
        <!-- Content will be populated by JavaScript -->
      </div>
    </div>
  </div>
</body>
</html>
