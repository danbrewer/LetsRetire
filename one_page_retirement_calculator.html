<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>One‑Page Retirement Calculator</title>
  <!-- jsPDF library for PDF generation -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    :root {
      --bg: #0b1220;
      --card: #121a2b;
      --muted: #7c8db5;
      --text: #e6eefc;
      --accent: #6ea8fe;
      --good: #45d483;
      --bad: #ff6b6b;
      --warn: #ffbf69;
      --border: #22304d;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, "Helvetica Neue", Arial, "Apple Color Emoji", "Segoe UI Emoji";
      margin: 0;
      color: var(--text);
      background: radial-gradient(1200px 900px at 15% -10%, #1a2440, #0b1220 50%);
    }
    header {
      padding: 20px clamp(16px, 3vw, 40px);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      position: sticky; top: 0; backdrop-filter: blur(6px);
      background: linear-gradient(180deg, rgba(11,18,32,.85), rgba(11,18,32,.55));
      border-bottom: 1px solid var(--border);
      z-index: 10;
    }
    .title { font-weight: 700; letter-spacing:.2px; }
    .title small{ color: var(--muted); font-weight: 500; }
    .wrap {
      display: grid;
      grid-template-columns: 360px 1fr;
      gap: 18px;
      padding: clamp(16px, 3vw, 40px);
      align-items: start;
    }
    @media (max-width: 980px){ .wrap{ grid-template-columns: 1fr; } }

    .card {
      background: linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.00));
      border: 1px solid var(--border);
      border-radius: 16px;
      box-shadow: 0 10px 30px rgba(0,0,0,.2);
    }
    .panel { padding: 18px; }
    .panel h3 { margin: 0 0 8px; font-size: 14px; color: var(--muted); font-weight: 600; letter-spacing:.4px; text-transform: uppercase; }

    /* Make inputs section independently scrollable */
    .card:first-of-type .sections {
      max-height: 100vh;
      overflow-y: auto;
    }

    .sections { display: grid; gap: 12px; }
    details { border: 1px solid var(--border); border-radius: 12px; overflow: hidden; }
    details[open] summary { background: #0d172b; }
    summary { padding: 14px 14px; cursor: pointer; list-style: none; user-select: none; display:flex; align-items:center; justify-content:space-between; gap:8px; }
    summary::-webkit-details-marker{ display:none; }
    .chev { transition: transform .2s; }
    details[open] .chev{ transform: rotate(90deg); }
    .content { padding: 14px; border-top: 1px dashed var(--border); background: rgba(255,255,255,.02); display:grid; gap:10px; }

    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .grid-1 { display: grid; grid-template-columns: repeat(1, 1fr); gap: 10px; }
    .grid-2 { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
    .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
    @media (max-width: 520px){ .grid, .grid-2, .grid-3 { grid-template-columns: 1fr; } }

    label { display: block; font-size: 12px; color: var(--muted); margin-bottom: 4px; }
    input, select { width: 100%; padding: 10px 11px; background: #0b1426; color: var(--text); border: 1px solid var(--border); border-radius: 10px; outline: none; }
    input:focus, select:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(110,168,254,.15); }
    .hint { font-size: 12px; color: var(--muted); }

    .actions { display:flex; gap:10px; padding: 14px; border-top: 1px solid var(--border); background: #0c1323; justify-content:flex-end; border-radius: 0 0 16px 16px; }
    button {
      appearance: none; border: 1px solid var(--border); background: #0f1930; color: var(--text);
      padding: 10px 14px; border-radius: 10px; font-weight: 600; cursor: pointer; transition: .2s;
    }
    .primary { background: linear-gradient(180deg, #2b63ff, #2349d2); border-color: #1f3fb8; }
    #pdfBtn { background: linear-gradient(180deg, #d63384, #b02a5b); border-color: #9a2456; color: white; }
    button:hover { transform: translateY(-1px); filter: brightness(1.07); }

    .results { 
      padding: 18px; 
      display: grid; 
      gap: 12px; 
      max-height: 90vh;
      overflow-y: auto;
    }
    .summary { display: grid; grid-template-columns: repeat(4, minmax(0,1fr)); gap: 10px; }
    @media (max-width: 900px){ .summary{ grid-template-columns: repeat(2, minmax(0,1fr)); } }
    .kpi { background: #0b1426; border: 1px solid var(--border); border-radius: 12px; padding: 12px; }
    .kpi .label { color: var(--muted); font-size: 12px; }
    .kpi .value { font-size: 20px; font-weight: 700; margin-top: 2px; }

    canvas { width: 100%; height: 260px; background: #0b1426; border: 1px solid var(--border); border-radius: 12px; position: relative; }

    /* Chart tooltip styles */
    .chart-tooltip {
      position: absolute;
      background: rgba(13, 23, 43, 0.95);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 8px 12px;
      font-size: 12px;
      color: var(--text);
      pointer-events: none;
      z-index: 1000;
      opacity: 0;
      transition: opacity 0.2s ease;
      backdrop-filter: blur(8px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }
    .chart-tooltip.visible {
      opacity: 1;
    }
    .chart-tooltip .year {
      font-weight: 600;
      color: #6ea8fe;
      margin-bottom: 2px;
    }
    .chart-tooltip .balance {
      color: var(--text);
    }

    table { width: 100%; border-collapse: collapse; font-size: 13px; }
    th, td { border-bottom: 1px solid var(--border); padding: 8px; text-align: right; white-space: nowrap; }
    th:first-child, td:first-child, th:nth-child(2), td:nth-child(2) { text-align: left; }
    thead th { position: sticky; top: 0; background: #0d172b; z-index: 1; }
    tbody tr:hover { background: rgba(255,255,255,.03); }

    /* Frozen columns: Year and Age ONLY - Solid background approach */
    
    /* First row headers (section headers) - Year and Age have rowspan=2 */
    thead tr.section-headers th:nth-child(1), /* Year */
    thead tr.section-headers th:nth-child(2)  /* Age */ {
      position: sticky;
      top: 0;
      z-index: 4;
      background: #0d172b;
      border-right: 2px solid var(--border);
    }
    thead tr.section-headers th:nth-child(1) { 
      left: 0; 
      min-width: 70px;
    }
    thead tr.section-headers th:nth-child(2) { 
      left: 70px; 
      min-width: 60px;
    }
    
    /* Add solid background extensions using pseudo-elements */
    thead tr.section-headers th:nth-child(1):after {
      content: '';
      position: absolute;
      top: 0;
      bottom: 0;
      left: 100%;
      width: 2px;
      background: #0d172b;
      z-index: 1;
    }
    thead tr.section-headers th:nth-child(2):after {
      content: '';
      position: absolute;
      top: 0;
      bottom: 0;
      left: 100%;
      width: 2px;
      background: #0d172b;
      z-index: 1;
    }
    
    /* Second row headers (column headers) - sticky top only */
    thead tr.column-headers th {
      position: sticky;
      z-index: 3;
      background: #051d08;
    }
    
    /* Body cells - only first two columns (Year and Age) */
    tbody td:nth-child(1) { /* Year */
      position: sticky;
      left: 0;
      background: #0d172b;
      z-index: 2;
      border-right: 2px solid var(--border);
      min-width: 70px;
    }
    tbody td:nth-child(2) { /* Age */
      position: sticky;
      left: 70px;
      background: #0d172b;
      z-index: 2;
      border-right: 2px solid var(--border);
      min-width: 60px;
    }
    
    /* Add solid background extensions for body cells */
    tbody td:nth-child(1):after {
      content: '';
      position: absolute;
      top: 0;
      bottom: 0;
      left: 100%;
      width: 2px;
      background: #0d172b;
      z-index: 1;
    }
    tbody td:nth-child(2):after {
      content: '';
      position: absolute;
      top: 0;
      bottom: 0;
      left: 100%;
      width: 2px;
      background: #0d172b;
      z-index: 1;
    }
    
    /* Ensure hover state doesn't interfere with frozen columns */
    tbody tr:hover td:nth-child(1), 
    tbody tr:hover td:nth-child(2) {
      background: #0d172b !important;
    }
    tbody tr:hover td:nth-child(1):after,
    tbody tr:hover td:nth-child(2):after {
      background: #0d172b !important;
    }
    
    /* Ensure all other columns scroll normally */
    tbody td:nth-child(n+3) {
      position: relative;
      left: auto;
      z-index: auto;
    }

    /* Section header styling */
    .section-headers th {
      background: linear-gradient(135deg, #4a5568 0%, #2d3748 100%);
      color: white;
      font-weight: 600;
      padding: 12px 8px;
      text-align: center;
      border: 1px solid #2d3748;
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      top: 0;
      z-index: 2;
    }
    
    /* Individual column header styling */
    .column-headers th {
      background: #1a2332;
      color: #e6eefc;
      font-weight: 500;
      padding: 8px 6px;
      text-align: center;
      border: 1px solid var(--border);
      font-size: 11px;
      top: 41px;
      z-index: 1;
    }
    
    /* Section-specific colors for main headers */
    .timeline-header { background: linear-gradient(135deg, #2b6cb0 0%, #1e4a8c 100%) !important; }
    .need-header { background: linear-gradient(135deg, #c53030 0%, #9b2c2c 100%) !important; }
    .income-header { background: linear-gradient(135deg, #38a169 0%, #2f855a 100%) !important; }
    .gross-income-header { background: linear-gradient(135deg, #f56500 0%, #dd6b20 100%) !important; }
    .withdrawal-header { background: linear-gradient(135deg, #d69e2e 0%, #b7791f 100%) !important; }
    .breakdown-header { background: linear-gradient(135deg, #805ad5 0%, #6b46c1 100%) !important; }
    .tax-header { background: linear-gradient(135deg, #e53e3e 0%, #c53030 100%) !important; }
    .balance-header { background: linear-gradient(135deg, #3182ce 0%, #2c5aa0 100%) !important; }

    /* Color coding for table values */
    .income { color: #4ade80; } /* Green for income */
    .outgoing { color: #f87171; } /* Red for outgoing */
    .neutral { color: var(--text); } /* Default color for neutral items */

    .pill { padding:.2rem .5rem; border-radius: 999px; font-size: 12px; font-weight:600; display:inline-block; }
    .ok { color: #0b5; background: rgba(69,212,131,.15); border: 1px solid rgba(69,212,131,.3); }
    .alert { color: #ff6b6b; background: rgba(255,107,107,.15); border:1px solid rgba(255,107,107,.3); }
    .warn { color: #ffbf69; background: rgba(255,191,105,.15); border:1px solid rgba(255,191,105,.3); }
    .disclaimer { color: var(--muted); font-size: 12px; }
    
    /* SS Breakdown Popup Styles */
    .ss-popup {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      z-index: 100000;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    
    .ss-popup.show {
      display: flex;
    }
    
    .ss-popup-content {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 24px;
      max-width: 500px;
      width: 100%;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 20px 50px rgba(0, 0, 0, 0.4);
    }

    .ss-popup-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    
    .ss-popup-title {
      font-size: 18px;
      font-weight: 600;
      color: var(--text);
      margin: 0;
    }
    
    .ss-popup-close {
      background: none;
      border: none;
      color: var(--muted);
      font-size: 24px;
      cursor: pointer;
      padding: 0;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
    }
    
    .ss-popup-close:hover {
      background: rgba(255, 255, 255, 0.1);
      color: var(--text);
    }
    
    .ss-breakdown-item {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid var(--border);
    }
    
    .ss-breakdown-item:last-child {
      border-bottom: none;
      font-weight: 600;
      padding-top: 12px;
      margin-top: 8px;
      border-top: 2px solid var(--border);
    }
    
    .ss-breakdown-label {
      color: var(--muted);
    }
    
    .ss-breakdown-value {
      color: var(--text);
      font-weight: 500;
    }

    /* Total row styling for breakdown tables */
    .total-row td {
      border-top: 3px double var(--border);
      padding-top: 12px;
      font-weight: 600;
    }

    /* Popup table header styling to obscure scrolling content */
    .ss-popup-content table thead th {
      position: sticky;
      top: -24px;
      background: var(--card);
      z-index: 10;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }
    
    /* Ensure popup table headers have solid background */
    .ss-popup-content .breakdown-table thead th {
      background: var(--card);
      backdrop-filter: blur(8px);
      border-bottom: 2px solid var(--border);
    }
    
    .ss-breakdown-item:last-child .ss-breakdown-label,
    .ss-breakdown-item:last-child .ss-breakdown-value {
      color: var(--accent);
    }
    
    /* Clickable SS link styling */
    .ss-link {
      color: inherit;
      text-decoration: underline;
      cursor: pointer;
      text-decoration-style: dotted;
    }
    
    .ss-link:hover {
      color: var(--accent);
      text-decoration-style: solid;
    }
    
    /* Clickable Taxable Income link styling */
    .taxable-income-link {
      color: inherit;
      text-decoration: underline;
      cursor: pointer;
      text-decoration-style: dotted;
    }
    
    .taxable-income-link:hover {
      color: var(--accent);
      text-decoration-style: solid;
    }
    
    /* Clickable Withdrawal Net link styling */
    .withdrawal-net-link {
      color: inherit;
      text-decoration: underline;
      cursor: pointer;
      text-decoration-style: dotted;
    }
    
    .withdrawal-net-link:hover {
      color: var(--accent);
      text-decoration-style: solid;
    }
    
    /* Clickable Non-taxable Income link styling */
    .non-taxable-income-link {
      color: inherit;
      text-decoration: underline;
      cursor: pointer;
      text-decoration-style: dotted;
    }
    
    .non-taxable-income-link:hover {
      color: var(--accent);
      text-decoration-style: solid;
    }
    
    /* Clickable Total Taxes link styling */
    .total-taxes-link {
      color: inherit;
      text-decoration: underline;
      cursor: pointer;
      text-decoration-style: dotted;
    }
    
    .total-taxes-link:hover {
      color: var(--accent);
      text-decoration-style: solid;
    }
    
    /* Clickable Savings Balance link styling */
    .savings-balance-link {
      color: inherit;
      text-decoration: underline;
      cursor: pointer;
      text-decoration-style: dotted;
    }
    
    .savings-balance-link:hover {
      color: var(--accent);
      text-decoration-style: solid;
    }

    /* Toast Notification Styles */
    .toast {
      position: fixed !important;
      top: 20px !important;
      right: 20px !important;
      background: #fffbf0 !important;
      border: 1px solid #f0ad4e !important;
      border-radius: 8px !important;
      padding: 16px !important;
      max-width: 300px !important;
      box-shadow: 0 4px 12px rgba(240, 173, 78, 0.3) !important;
      z-index: 99999 !important;
      opacity: 0 !important;
      transform: translateY(-10px) !important;
      transition: opacity 0.3s ease, transform 0.3s ease !important;
      overflow: visible !important;
      pointer-events: auto !important;
      display: block !important;
      visibility: visible !important;
      width: auto !important;
      height: auto !important;
    }
    .toast.show {
      opacity: 1 !important;
      transform: translateY(0) !important;
      visibility: visible !important;
    }
    .toast .toast-title {
      font-weight: 600;
      color: #8a6914;
      margin-bottom: 8px;
      font-size: 14px;
    }
    .toast .toast-body {
      color: #856404;
      font-size: 13px;
      line-height: 1.4;
    }
    .toast .progress-bar {
      position: absolute;
      bottom: 0;
      left: 0;
      height: 3px;
      background: #f0ad4e;
      transition: width linear;
      border-radius: 0 0 8px 8px;
      width: 0%;
    }
    
    /* Toast Type Variations */
    .toast-success {
      background: #f0fff4 !important;
      border-color: #28a745 !important;
      box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3) !important;
    }
    .toast-success .toast-title {
      color: #155724;
    }
    .toast-success .toast-body {
      color: #155724;
    }
    .toast-success .progress-bar {
      background: #28a745;
    }
    
    .toast-error {
      background: #fff5f5 !important;
      border-color: #dc3545 !important;
      box-shadow: 0 4px 12px rgba(220, 53, 69, 0.3) !important;
    }
    .toast-error .toast-title {
      color: #721c24;
    }
    .toast-error .toast-body {
      color: #721c24;
    }
    .toast-error .progress-bar {
      background: #dc3545;
    }
    
    .toast-warning {
      background: #fffbf0 !important;
      border-color: #ffc107 !important;
      box-shadow: 0 4px 12px rgba(255, 193, 7, 0.3) !important;
    }
    .toast-warning .toast-title {
      color: #856404;
    }
    .toast-warning .toast-body {
      color: #856404;
    }
    .toast-warning .progress-bar {
      background: #ffc107;
    }
    
    .toast-info {
      background: #f0f8ff !important;
      border-color: #17a2b8 !important;
      box-shadow: 0 4px 12px rgba(23, 162, 184, 0.3) !important;
    }
    .toast-info .toast-title {
      color: #0c5460;
    }
    .toast-info .toast-body {
      color: #0c5460;
    }
    .toast-info .progress-bar {
      background: #17a2b8;
    }
    
    .help-icon {
      cursor: pointer;
      transition: opacity 0.2s ease;
      margin-left: 0.3em;
      vertical-align: middle;
    }
    .help-icon:hover {
      opacity: 0.7;
    }
  </style>
</head>
<body>
  <header>
    <div class="title">
      <div style="font-size:20px">Retirement Calculator</div>
      <small>Pre‑tax vs Roth vs Taxable • Social Security • Pension • Spouse benefits • Declining spending • Employer match</small>
    </div>
    <div>
      <input type="file" id="jsonFileInput" accept=".json" style="display: none;">
      <button id="clearBtn">Reset</button>
      <button id="calcBtn" class="primary" title="Calculate (Ctrl+Enter)">Calculate ▶</button>
    </div>
  </header>

  <main class="wrap">
    <!-- Inputs -->
    <section class="card">
      <div class="panel">
        <h3>Inputs</h3>
        <div class="sections">
          <!-- Personal -->
          <details>
            <summary>
              <span>👤 Personal & Timeline</span>
              <span class="chev">▶</span>
            </summary>
            <div class="content grid">
              <div>
                <label for="currentAge">Current age 
                  <span class="help-icon-placeholder" data-field="currentAge"></span>
                </label>
                <input id="currentAge" type="number" min="18" max="80" step="1" value="45" />
              </div>
              <div>
                <label for="retireAge">Retirement age
                  <span class="help-icon-placeholder" data-field="retireAge"></span>
                </label>
                <input id="retireAge" type="number" min="40" max="80" step="1" value="67" />
              </div>
              <div>
                <label for="endAge">Plan to age
                  <span class="help-icon-placeholder" data-field="endAge"></span>
                </label>
                <input id="endAge" type="number" min="70" max="110" step="1" value="95" />
              </div>
              <div>
                <label for="inflation">Inflation (%)
                  <span class="help-icon-placeholder" data-field="inflation"></span>
                </label>
                <input id="inflation" type="number" step="0.1" value="2.5" />
              </div>
              <div>
                <label for="spendingToday">Retirement spending (today's $ / yr)
                  <span class="help-icon-placeholder" data-field="spendingToday"></span>
                </label>
                <input id="spendingToday" type="number" step="1000" value="80000" />
                <div class="hint">We'll inflate this to retirement, then apply COLA annually.</div>
              </div>
              <div>
                <label for="spendingDecline">Annual spending decline in retirement (%)
                  <span class="help-icon-placeholder" data-field="spendingDecline"></span>
                </label>
                <input id="spendingDecline" type="number" step="0.1" value="0" />
                <div class="hint">Spending reduction each year (e.g., 2% = spending drops to 98%, then 96%, etc.)</div>
              </div>
            </div>
          </details>

          <!-- Spouse Information -->
          <details>
            <summary>
              <span>👥 Spouse Information</span>
              <span class="chev">▶</span>
            </summary>
            <div class="content">
              <div class="grid-2">
                <div>
                  <label for="spouseAge">Current age
                    <span class="help-icon-placeholder" data-field="spouseAge"></span>
                  </label>
                  <input id="spouseAge" type="number" min="18" max="80" step="1" value="0" />
                  <div class="hint">Set to 0 if no spouse</div>
                </div>
                <div>
                  <label for="spouseRetireAge">Retirement age
                    <span class="help-icon-placeholder" data-field="spouseRetireAge"></span>
                  </label>
                  <input id="spouseRetireAge" type="number" min="40" max="80" step="1" value="67" />
                </div>
              </div>
              <div class="grid-1">
                
                <div>
                  <label for="spouseSsStart">Social Sec start age</label>
                  <input id="spouseSsStart" type="number" step="1" value="67" />
                </div>
              </div>
              <div class="grid-2">
                <div>
                  <label for="spouseSsMonthly">$/Month (1st yr benefits)</label>
                  <input id="spouseSsMonthly" type="number" step="50" value="0" />
                </div>
                
                <div>
                  <label for="spouseSsCola">Social Sec COLA (%/yr)</label>
                  <input id="spouseSsCola" type="number" step="0.1" value="2.0" />
                </div>
              </div>
              <div class=""grid-1">
                <div>
                  <label for="spousePenStart">Pension start age</label>
                  <input id="spousePenStart" type="number" step="1" value="65" />
                </div>
              </div>
              <div class="grid-2">
                <div>
                  <label for="spousePenMonthly">Pension disbursement ($/mo, first year)</label>
                  <input id="spousePenMonthly" type="number" step="50" value="0" />
                </div>
                <div>
                  <label for="spousePenCola">Spouse Pension COLA (%/yr)</label>
                  <input id="spousePenCola" type="number" step="0.1" value="0" />
                </div>
              </div>
              <div class="grid-2">
                <div>
                  <label for="spouseTaxSS">Effective tax on Spouse Social Security (%)</label>
                  <input id="spouseTaxSS" type="number" step="0.5" value="10" />
                </div>
                <div>
                  <label for="spouseTaxPension">Effective tax on Spouse Pension (%)</label>
                  <input id="spouseTaxPension" type="number" step="0.5" value="20" />
                </div>
              </div>
            </div>
          </details>

          <!-- Work & Contributions -->
          <details>
            <summary>
              <span>💼 Work & Contributions</span>
              <span class="chev">▶</span>
            </summary>
            <div class="content">
              <div class="grid">
                <div>
                  <label for="salary">Current salary ($/yr)
                    <span class="help-icon-placeholder" data-field="salary"></span>
                  </label>
                  <input id="salary" type="number" step="1000" value="150000" />
                </div>
                <div>
                  <label for="salaryGrowth">Salary growth (%)
                    <span class="help-icon-placeholder" data-field="salaryGrowth"></span>
                  </label>
                  <input id="salaryGrowth" type="number" step="0.1" value="3.0" />
                </div>
              </div>
              <div>
                <label for="pretaxPct">Pre‑tax 401k/IRA contribution (% of salary)
                  <span class="help-icon-placeholder" data-field="pretaxPct"></span>
                </label>
                <input id="pretaxPct" type="number" step="0.1" value="10" />
              </div>
              <div>
                <label for="rothPct">Roth contribution (% of salary)
                  <span class="help-icon-placeholder" data-field="rothPct"></span>
                </label>
                <input id="rothPct" type="number" step="0.1" value="5" />
              </div>
              <div>
                <label for="taxablePct">Savings rate (% of salary)
                  <span class="help-icon-placeholder" data-field="taxablePct"></span>
                </label>
                <input id="taxablePct" type="number" step="0.1" value="2" />
              </div>
              <div>
                <label for="matchCap">Employer 401k match up to (% of salary)</label>
                <input id="matchCap" type="number" step="0.1" value="4" />
              </div>
              <div>
                <label for="matchRate">Employer 401k match rate (%)</label>
                <input id="matchRate" type="number" step="1" value="50" />
              </div>
            </div>
          </details>

          <!-- Balances & Returns -->
          <details>
            <summary>
              <span>💰 Balances & Returns</span>
              <span class="chev">▶</span>
            </summary>
            <div class="content">
              <div class="grid-1">
                <div>
                  <label for="balPre">Pre‑tax (401k/Trad IRA) balance
                    <svg xmlns="http://www.w3.org/2000/svg" 
                         viewBox="0 0 24 24" 
                         width="1em" height="1em" 
                         fill="white" 
                         class="help-icon"
                         onclick="showHelpToast(event, 'balPre')"
                         style="vertical-align: middle;">
                      <circle cx="12" cy="12" r="10" stroke="white" stroke-width="2" fill="none"/>
                      <path d="M9.5 9a2.5 2.5 0 0 1 5 0c0 1.5-2.5 2-2.5 3.5v1" stroke="white" stroke-width="2" fill="none" stroke-linecap="round"/>
                      <circle cx="12" cy="17" r="1" fill="white"/>
                    </svg>
                  </label>
                  <input id="balPre" type="number" step="1000" value="400000" />
                </div>
                <div class="grid-1">
                <div>
                  <label for="balRoth">Roth balance (tax-free)
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="1em" height="1em" fill="white" class="help-icon"
                      onclick="showHelpToast(event, 'balRoth')" style="vertical-align: middle;">
                      <circle cx="12" cy="12" r="10" stroke="white" stroke-width="2" fill="none" />
                      <path d="M9.5 9a2.5 2.5 0 0 1 5 0c0 1.5-2.5 2-2.5 3.5v1" stroke="white" stroke-width="2" fill="none"
                        stroke-linecap="round" />
                      <circle cx="12" cy="17" r="1" fill="white" />
                    </svg>
                  </label>
                  <input id="balRoth" type="number" step="1000" value="100000" />
                </div>

                </div>
                <div class="grid-1">
                  <label for="balSavings">Savings balance (taxable interest/dividends)
                    <svg xmlns="http://www.w3.org/2000/svg" 
                         viewBox="0 0 24 24" 
                         width="1em" height="1em" 
                         fill="white" 
                         class="help-icon"
                         onclick="showHelpToast(event, 'balSavings')"
                         style="vertical-align: middle;">
                      <circle cx="12" cy="12" r="10" stroke="white" stroke-width="2" fill="none"/>
                      <path d="M9.5 9a2.5 2.5 0 0 1 5 0c0 1.5-2.5 2-2.5 3.5v1" stroke="white" stroke-width="2" fill="none" stroke-linecap="round"/>
                      <circle cx="12" cy="17" r="1" fill="white"/>
                    </svg>
                  </label>
                  <input id="balSavings" type="number" step="1000" value="80000" />
                </div>
              </div>
              <div class="grid-3">
                <div>
                  <label for="retPre">Pre‑tax return (%/yr)
                    <svg xmlns="http://www.w3.org/2000/svg" 
                         viewBox="0 0 24 24" 
                         width="1em" height="1em" 
                         fill="white" 
                         class="help-icon"
                         onclick="showHelpToast(event, 'retPre')"
                         style="vertical-align: middle;">
                      <circle cx="12" cy="12" r="10" stroke="white" stroke-width="2" fill="none"/>
                      <path d="M9.5 9a2.5 2.5 0 0 1 5 0c0 1.5-2.5 2-2.5 3.5v1" stroke="white" stroke-width="2" fill="none" stroke-linecap="round"/>
                      <circle cx="12" cy="17" r="1" fill="white"/>
                    </svg>
                  </label>
                  <input id="retPre" type="number" step="0.1" value="6.0" />
                </div>
                <div>
                  <label for="retRoth">Roth return (%/yr)
                    <svg xmlns="http://www.w3.org/2000/svg" 
                         viewBox="0 0 24 24" 
                         width="1em" height="1em" 
                         fill="white" 
                         class="help-icon"
                         onclick="showHelpToast(event, 'retRoth')"
                         style="vertical-align: middle;">
                      <circle cx="12" cy="12" r="10" stroke="white" stroke-width="2" fill="none"/>
                      <path d="M9.5 9a2.5 2.5 0 0 1 5 0c0 1.5-2.5 2-2.5 3.5v1" stroke="white" stroke-width="2" fill="none" stroke-linecap="round"/>
                      <circle cx="12" cy="17" r="1" fill="white"/>
                    </svg>
                  </label>
                  <input id="retRoth" type="number" step="0.1" value="6.0" />
                </div>
                <div>
                  <label for="retTax">Savings return (APY)
                    <svg xmlns="http://www.w3.org/2000/svg" 
                         viewBox="0 0 24 24" 
                         width="1em" height="1em" 
                         fill="white" 
                         class="help-icon"
                         onclick="showHelpToast(event, 'retTax')"
                         style="vertical-align: middle;">
                      <circle cx="12" cy="12" r="10" stroke="white" stroke-width="2" fill="none"/>
                      <path d="M9.5 9a2.5 2.5 0 0 1 5 0c0 1.5-2.5 2-2.5 3.5v1" stroke="white" stroke-width="2" fill="none" stroke-linecap="round"/>
                      <circle cx="12" cy="17" r="1" fill="white"/>
                    </svg>
                  </label>
                  <input id="retTax" type="number" step="0.1" value="5.5" />
                </div>
              </div>
            </div>
          </details>

          <!-- Income Sources -->
          <details>
            <summary>
              <span>🏛️ Social Security & Pension</span>
              <span class="chev">▶</span>
            </summary>
            <div class="content">
              <div class="grid-2">
                <div>
                  <label for="ssMonthly">Social Security ($/mo, first year)
                    <svg xmlns="http://www.w3.org/2000/svg" 
                         viewBox="0 0 24 24" 
                         width="1em" height="1em" 
                         fill="white" 
                         class="help-icon"
                         onclick="showHelpToast(event, 'ssMonthly')"
                         style="vertical-align: middle;">
                      <circle cx="12" cy="12" r="10" stroke="white" stroke-width="2" fill="none"/>
                      <path d="M9.5 9a2.5 2.5 0 0 1 5 0c0 1.5-2.5 2-2.5 3.5v1" stroke="white" stroke-width="2" fill="none" stroke-linecap="round"/>
                      <circle cx="12" cy="17" r="1" fill="white"/>
                    </svg>
                  </label>
                  <input id="ssMonthly" type="number" step="50" value="2800" />
                </div>
                <div>
                  <label for="ssStart">SS start age
                    <svg xmlns="http://www.w3.org/2000/svg" 
                         viewBox="0 0 24 24" 
                         width="1em" height="1em" 
                         fill="white" 
                         class="help-icon"
                         onclick="showHelpToast(event, 'ssStart')"
                         style="vertical-align: middle;">
                      <circle cx="12" cy="12" r="10" stroke="white" stroke-width="2" fill="none"/>
                      <path d="M9.5 9a2.5 2.5 0 0 1 5 0c0 1.5-2.5 2-2.5 3.5v1" stroke="white" stroke-width="2" fill="none" stroke-linecap="round"/>
                      <circle cx="12" cy="17" r="1" fill="white"/>
                    </svg>
                  </label>
                  <input id="ssStart" type="number" step="1" value="67" />
                </div>
                <div>
                  <label for="ssCola">SS COLA (%/yr)
                    <svg xmlns="http://www.w3.org/2000/svg" 
                         viewBox="0 0 24 24" 
                         width="1em" height="1em" 
                         fill="white" 
                         class="help-icon"
                         onclick="showHelpToast(event, 'ssCola')"
                         style="vertical-align: middle;">
                      <circle cx="12" cy="12" r="10" stroke="white" stroke-width="2" fill="none"/>
                      <path d="M9.5 9a2.5 2.5 0 0 1 5 0c0 1.5-2.5 2-2.5 3.5v1" stroke="white" stroke-width="2" fill="none" stroke-linecap="round"/>
                      <circle cx="12" cy="17" r="1" fill="white"/>
                    </svg>
                  </label>
                  <input id="ssCola" type="number" step="0.1" value="2.0" />
                </div>
              </div>
              <div class="grid-3">
                <div>
                  <label for="penMonthly">Pension ($/mo, first year)
                    <svg xmlns="http://www.w3.org/2000/svg" 
                         viewBox="0 0 24 24" 
                         width="1em" height="1em" 
                         fill="white" 
                         class="help-icon"
                         onclick="showHelpToast(event, 'penMonthly')"
                         style="vertical-align: middle;">
                      <circle cx="12" cy="12" r="10" stroke="white" stroke-width="2" fill="none"/>
                      <path d="M9.5 9a2.5 2.5 0 0 1 5 0c0 1.5-2.5 2-2.5 3.5v1" stroke="white" stroke-width="2" fill="none" stroke-linecap="round"/>
                      <circle cx="12" cy="17" r="1" fill="white"/>
                    </svg>
                  </label>
                  <input id="penMonthly" type="number" step="50" value="0" />
                </div>
                <div>
                  <label for="penStart">Pension start age
                    <svg xmlns="http://www.w3.org/2000/svg" 
                         viewBox="0 0 24 24" 
                         width="1em" height="1em" 
                         fill="white" 
                         class="help-icon"
                         onclick="showHelpToast(event, 'penStart')"
                         style="vertical-align: middle;">
                      <circle cx="12" cy="12" r="10" stroke="white" stroke-width="2" fill="none"/>
                      <path d="M9.5 9a2.5 2.5 0 0 1 5 0c0 1.5-2.5 2-2.5 3.5v1" stroke="white" stroke-width="2" fill="none" stroke-linecap="round"/>
                      <circle cx="12" cy="17" r="1" fill="white"/>
                    </svg>
                  </label>
                  <input id="penStart" type="number" step="1" value="65" />
                </div>
                <div>
                  <label for="penCola">Pension COLA (%/yr)
                    <svg xmlns="http://www.w3.org/2000/svg" 
                         viewBox="0 0 24 24" 
                         width="1em" height="1em" 
                         fill="white" 
                         class="help-icon"
                         onclick="showHelpToast(event, 'penCola')"
                         style="vertical-align: middle;">
                      <circle cx="12" cy="12" r="10" stroke="white" stroke-width="2" fill="none"/>
                      <path d="M9.5 9a2.5 2.5 0 0 1 5 0c0 1.5-2.5 2-2.5 3.5v1" stroke="white" stroke-width="2" fill="none" stroke-linecap="round"/>
                      <circle cx="12" cy="17" r="1" fill="white"/>
                    </svg>
                  </label>
                  <input id="penCola" type="number" step="0.1" value="0" />
                </div>
              </div>
            </div>
          </details>

          <!-- Taxes & Strategy -->
          <details>
            <summary>
              <span>📊 Taxes & Withdrawal Strategy</span>
              <span class="chev">▶</span>
            </summary>
            <div class="content">
              <div class="grid-3">
                <div>
                  <label for="taxPre">Effective tax on pre‑tax withdrawals (%)
                    <span class="help-icon-placeholder" data-field="taxPre"></span>
                  </label>
                  <input id="taxPre" type="number" step="0.5" value="22" />
                </div>
                <div>
                  <label for="taxTaxable">Effective tax on taxable withdrawals (%)
                    <span class="help-icon-placeholder" data-field="taxTaxable"></span>
                  </label>
                  <input id="taxTaxable" type="number" step="0.5" value="10" />
                </div>
                <div>
                  <label for="taxRoth">Effective tax on Roth withdrawals (%)
                    <span class="help-icon-placeholder" data-field="taxRoth"></span>
                  </label>
                  <input id="taxRoth" type="number" step="0.5" value="0" />
                </div>
              </div>
              <div class="grid-3">
                <div>
                  <label for="taxSS">Effective tax on Social Security (%)
                    <span class="help-icon-placeholder"  data-field="taxSS"></span>
                  </label>
                  <input id="taxSS" type="number" step="0.5" value="10" />
                </div>
                <div>
                  <label for="taxPension">Effective tax on Pension (%)
                    <span class="help-icon-placeholder" data-field="taxPension"></span>
                  </label>
                  <input id="taxPension" type="number" step="0.5" value="20" />
                </div>
                <div>
                  <label for="order">Withdrawal order
                    <span class="help-icon-placeholder" data-field="order"></span>
                  </label>
                  <select id="order">
                    <option value="taxable,pretax,roth">Savings → 401k → Roth (default)</option>
                    <option value="pretax,taxable,roth">401k → Savings → Roth</option>
                    <option value="roth,pretax,taxable">Roth → Pre‑tax → Taxable</option>
                    <option value="50/50">50/50 Savings/401k (after SS & Pension)</option>
                  </select>
                </div>
              </div>
              <div style="margin-top: 15px;">
                <div style="display: flex; align-items: center; gap: 5px;">
                  <input type="checkbox" id="useAgiTax" checked style="width: auto;" />
                  <label for="useAgiTax">
                    Use Taxable Income-based tax calculation for pre-tax withdrawals and pension income
                    <span class="help-icon-placeholder" data-field="useAgiTax"></span>
                  </label>
                </div>
              </div>
              <div style="margin-top: 10px;">
                <label for="filingStatus">Tax filing status
                  <span class="help-icon-placeholder" data-field="filingStatus"></span>
                </label>
                <select id="filingStatus">
                  <option value="single">Single</option>
                  <option value="married">Married Filing Jointly</option>
                </select>
              </div>
              <div style="margin-top: 10px;">
                <div style="display: flex; align-items: center; gap: 5px;">
                  <input type="checkbox" id="useSSRules" checked style="width: auto;" />
                  <label for="useSSRules">
                    Use proper Social Security taxation rules
                    <span class="help-icon-placeholder" data-field="useSSRules"></span>
                  </label>
                </div>
              </div>
              <div style="margin-top: 10px;">
                <div style="display: flex; align-items: center; gap: 5px;">
                  <input type="checkbox" id="useRMD" checked style="width: auto;" />
                  <label for="useRMD">
                    Apply Required Minimum Distribution (RMD) rules
                    <span class="help-icon-placeholder" data-field="useRMD"></span>
                  </label>
                </div>
              </div>
              <div class="hint">These are simplified, all‑in effective rates to keep the model understandable (not tax advice).</div>
            </div>
          </details>

          <!-- Annual Spending Details -->
          <details>
            <summary>
              <span>🛒 Annual Spending Adjustments</span>
              <span class="chev">▶</span>
            </summary>
            <div class="content">
              <div class="hint">
                <div style="margin-bottom: 8px;">
                  Override calculated annual income for specific retirement years.
                  Leave fields blank to use automatic annual income calculations based on COLA and spending decline.
                </div>
                <div style="display: flex; align-items: center; gap: 5px;">
                  <input type="checkbox" id="useCurrentYearValues" style="width: auto;" />
                  <label for="useCurrentYearValues">
                    Use current year values (will be adjusted for inflation for target year)
                  </label>
                </div>
              </div>
            
              <div id="spendingDetailsGrid" class="grid-3">
                <!-- Spending override fields will be dynamically generated here -->
              </div>
            </div>
          </details>

          <!-- Taxable Income Adjustments -->
          <details>
            <summary>
              <span>📈 Taxable Income Adjustments</span>
              <span class="chev">▶</span>
            </summary>
            <div class="content">
              <div class="hint">
                <div style="margin-bottom: 8px;">
                  Add additional taxable income sources (rental income, part-time work, etc.) for specific years.
                  These amounts will be added to your annual salary and are subject to income tax.
                  Leave fields blank if no additional taxable income for that year.
                </div>
                <div style="display: flex; align-items: center; gap: 5px;">
                  <input type="checkbox" id="useTaxableCurrentYearValues" style="width: auto;" />
                  <label for="useTaxableCurrentYearValues">
                    Use current year values (will be adjusted for inflation for target year)
                  </label>
                </div>
              </div>
            
              <div id="taxableIncomeDetailsGrid" class="grid-3">
                <!-- Taxable income adjustment fields will be dynamically generated here -->
              </div>
            </div>
          </details>

          <!-- Tax-free Income Adjustments -->
          <details>
            <summary>
              <span>🎁 Tax-free Income Adjustments</span>
              <span class="chev">▶</span>
            </summary>
            <div class="content">
              <div class="hint">
                <div style="margin-bottom: 8px;">
                  Add additional tax-free income sources (gifts, inheritance, Roth conversions, etc.) for specific years.
                  These amounts will be added to your savings balance and are not subject to income tax.
                  Leave fields blank if no additional tax-free income for that year.
                </div>
                <div style="display: flex; align-items: center; gap: 5px;">
                  <input type="checkbox" id="useTaxFreeCurrentYearValues" style="width: auto;" />
                  <label for="useTaxFreeCurrentYearValues">
                    Use current year values (will be adjusted for inflation for target year)
                  </label>
                </div>
              </div>
            
              <div id="taxFreeIncomeDetailsGrid" class="grid-3">
                <!-- Tax-free income adjustment fields will be dynamically generated here -->
              </div>
            </div>
          </details>
        </div>
      </div>
      <div class="actions">
        <button id="pdfBtn" title="Generate comprehensive PDF report">PDF Report</button>
        <button id="csvBtn" title="Export yearly table">Export CSV</button>
        <button id="exportJsonBtn" title="Export inputs as JSON file">Export JSON</button>
        <button id="importJsonBtn" title="Import inputs from JSON file">Import JSON</button>
        <input type="file" id="jsonFileInput" accept=".json" style="display: none;">
      </div>
    </section>

    <!-- Results -->
    <section class="card">
      <div class="results">
        <div class="summary">
          <div class="kpi"><div class="label">Retirement Age</div><div id="kpiDraw" class="value">—</div></div>
          <div class="kpi"><div class="label">Funded to Age</div><div id="kpiAge" class="value">—</div></div>
          <div class="kpi"><div class="label">Starting Balance</div><div id="kpiTax" class="value">—</div></div>
          <div class="kpi"><div class="label">Ending Balance</div><div id="kpiEndBal" class="value">—</div></div>
        </div>
        <div style="position: relative;">
          <canvas id="chart" height="260"></canvas>
          <div id="chartTooltip" class="chart-tooltip">
            <div class="year"></div>
            <div class="balance"></div>
          </div>
        </div>
        <div class="card" style="padding:0; overflow:auto; max-height: 50vh;">
          <table>
            <thead>
              <!-- Main section headers -->
              <tr class="section-headers">
                <th rowspan="2" class="timeline-header">Year</th>
                <th rowspan="2" class="timeline-header">Age</th>
                <th rowspan="2" class="need-header">Annual Spend</th>
                <th colspan="7" class="income-header">Net Income</th>
                <th colspan="8" class="gross-income-header">Gross Income</th>
                <th colspan="2" class="breakdown-header">Income Breakdown</th>
                <th colspan="5" class="tax-header">Tax Information</th>
                <th colspan="4" class="balance-header">Account Balances</th>
              </tr>
              <!-- Sub-headers for individual columns -->
              <tr class="column-headers">
                <!-- Net Income (what you actually receive) -->
                <th>SS (Net)</th>
                <th>Pension (Net)</th>
                <th>Spouse SS (Net)</th>
                <th>Spouse Pen (Net)</th>
                <th>401k (Net)</th>
                <th>Savings/Roth</th>
                <th>Total Net</th>
                
                <!-- Gross Income (before taxes/deductions) -->
                <th>Salary</th>
                <th>Taxable Interest</th>
                <th>SS Gross</th>
                <th>Pension Gross</th>
                <th>Spouse SS Gross</th>
                <th>Spouse Pen Gross</th>
                <th>401k Gross</th>
                <th>Total Gross</th>
                
                <!-- Income Breakdown -->
                <th>Taxable Income</th>
                <th>Non-Taxable Income</th>
                
                <!-- Tax Information -->
                <th>SS Taxes</th>
                <th>Other Taxes</th>
                <th>Total Taxes</th>
                <th>Taxable Income</th>
                <th>Effective Tax Rate</th>
                
                <!-- Account Balances -->
                <th>Savings Bal</th>
                <th>401k Bal</th>
                <th>Roth Bal</th>
                <th>Total Bal</th>
              </tr>
            </thead>
            <tbody id="rows"></tbody>
          </table>
        </div>
        <div class="disclaimer">This is an educational, simplified model. It ignores many realities (RMDs, detailed SS taxability, brackets/credits, healthcare, sequence risk, etc.). Consult a fiduciary advisor and a tax professional for personalized guidance.</div>
      </div>
    </section>
  </main>

<script src="retirement-calculator.js"></script>

  <!-- SS Breakdown Popup -->
  <div id="ssPopup" class="ss-popup">
    <div class="ss-popup-content">
      <div class="ss-popup-header">
        <h3 class="ss-popup-title">Social Security Breakdown</h3>
        <button class="ss-popup-close" onclick="closeSsPopup()">&times;</button>
      </div>
      <div id="ssBreakdownContent">
        <!-- Content will be populated by JavaScript -->
      </div>
    </div>
  </div>
</body>
</html>
